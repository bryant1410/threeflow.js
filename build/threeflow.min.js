(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=function(a,b){return function(){return a.apply(b,arguments)}},w={}.hasOwnProperty,x=function(a,b){function c(){this.constructor=a}for(var d in b)w.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};window.THREEFLOW=window.THREEFLOW||{},Function.prototype.property||(Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)}),THREEFLOW.SunflowRenderer=s=function(){function a(a){this.onRenderComplete=v(this.onRenderComplete,this),this.onRenderProgress=v(this.onRenderProgress,this),this.onRenderStart=v(this.onRenderStart,this),this.onConnected=v(this.onConnected,this),a=a||{},this.pngPath=a.pngPath||null,this.scPath=a.scPath||null,this.scSave=a.scSave||!1,this.exporter=new g,this.image=this.exporter.image,this.traceDepths=this.exporter.traceDepths,this.caustics=this.exporter.caustics,this.gi=this.exporter.gi,this.cameras=this.exporter.cameras,this.lights=this.exporter.lights,this.materials=this.exporter.materials,this.geometry=this.exporter.geometry,this.meshes=this.exporter.meshes,this.connected=!1,this.rendering=!1}return a.prototype.connect=function(){return this.connected?void 0:(this.socket=io.connect(this.host),this.socket.on("connected",this.onConnected),this.socket.on("render-start",this.onRenderStart),this.socket.on("render-progress",this.onRenderProgress),this.socket.on("render-complete",this.onRenderComplete),null)},a.prototype.render=function(a,b,c,d){var e,f;if(!this.connected)throw new Error("[SunflowRenderer] Call connect() before rendering.");return this.rendering?console.log("QUEUE?"):(console.log("RENDER"),f=1,this.exporter.image.resolutionX=c*f,this.exporter.image.resolutionY=d*f,this.exporter.indexScene(a),e=this.exporter.exportCode(),this.socket.emit("render",{scContents:e,scPath:this.scPath,scSave:this.scSave,pngPath:this.pngPath})),null},a.prototype.onConnected=function(){return console.log("Threeflow conected."),this.connected=!0,null},a.prototype.onRenderStart=function(){return console.log("onRenderStart"),null},a.prototype.onRenderProgress=function(a){return console.log("onRenderProgress",a),null},a.prototype.onRenderComplete=function(a){return console.log("onRenderComplete",a),null},a}(),b=function(){function a(){}return a.prototype.addToIndex=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.doTraverse=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportBlock=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportColorTHREE=function(a){return'{ "sRGB nonlinear" '+a.r+" "+a.g+" "+a.b+" }"},a.prototype.exportColorHex=function(a){var b,c,d;return d=(a>>16&255)/255,c=(a>>8&255)/255,b=(255&a)/255,'{ "sRGB nonlinear" '+d+" "+c+" "+b+" }"},a.prototype.exportVector=function(a){return a.x+" "+a.y+" "+a.z},a.prototype.exportFace=function(a){return a.a+" "+a.b+" "+a.c},a.prototype.exportTransform=function(a){var b,c,d,e,f;for(c="",f=a.matrixWorld.elements,d=0,e=f.length;e>d;d++)b=f[d],c+=" "+b;return c},a.prototype.exportTransformPosition=function(a){var b,c;return c="",b=a.matrixWorld.elements,c+=b[12]+" "+b[13]+" "+b[14]},a}(),c=function(a){function b(){b.__super__.constructor.call(this),this.camera=null}return x(b,a),b.prototype.addToIndex=function(a){return this.camera?void 0:(a instanceof THREE.PerspectiveCamera&&(this.camera=a,console.log("SET CAMERA",this.camera)),null)},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.camera?(a+="camera {\n",a+="  type pinhole\n",a+="  eye "+this.exportVector(this.camera.position)+"\n",a+="  target "+this.exportVector(this.camera.rotation)+"\n",a+="  up "+this.exportVector(this.camera.up)+"\n",a+="  fov "+this.camera.fov*this.camera.aspect+"\n",a+="  aspect "+this.camera.aspect+"\n",a+="}\n\n"):a},b}(b),d=function(a){function b(){b.__super__.constructor.call(this),this.enabled=!1,this.photons=1e4,this.kdEstimate=100,this.kdRadius=.5}return x(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="photons {\n",a+="  caustics "+this.photons+" kd "+this.kdEstimate+" "+this.kdRadius+"\n",a+="}\n\n"):a},b}(b),g=function(){function a(){this.exporterSettings={convertPrimitives:!1},this.blockExporters=[],this.image=this.addBlockExporter(new k),this.traceDepths=this.addBlockExporter(new u),this.caustics=this.addBlockExporter(new d),this.gi=this.addBlockExporter(new i),this.cameras=this.addBlockExporter(new c),this.lights=this.addBlockExporter(new l),this.materials=this.addBlockExporter(new m),this.geometry=this.addBlockExporter(new h),this.meshes=this.addBlockExporter(new n)}return a.BUCKET_ORDERS=["hilbert","spiral","column","row","diagonal","random"],a.prototype.addBlockExporter=function(a){if(!a instanceof b)throw new Error("Extend BlockExporter");return this.blockExporters.push(a),a},a.prototype.indexScene=function(a){var b,c,d,e,f,g,h,i,j;if(a.children.length)for(i=a.children,e=0,g=i.length;g>e;e++){for(c=i[e],d=!0,j=this.blockExporters,f=0,h=j.length;h>f;f++)b=j[f],b.addToIndex(c),d=d&&b.doTraverse(c);d&&this.indexScene(c)}return null},a.prototype.exportCode=function(){var a,b,c,d,e;for(b="",e=this.blockExporters,c=0,d=e.length;d>c;c++)a=e[c],b+=a.exportBlock();return b},a}(),h=function(a){function b(){b.__super__.constructor.call(this),this.faceNormals=!1,this.vertexNormals=!1,this.geometryIndex={}}return x(b,a),b.prototype.addToIndex=function(a){var b;if(a instanceof THREE.Mesh&&a.geometry){if(a.geometry instanceof THREEFLOW.InfinitePlaneGeometry)return;b=a.material instanceof THREE.MeshFaceMaterial,this.geometryIndex[a.geometry.uuid]?!this.geometryIndex[a.geometry.uuid].faceMaterials&&b&&(this.geometryIndex[a.geometry.uuid].faceMaterials=!0):this.geometryIndex[a.geometry.uuid]={geometry:a.geometry,faceMaterials:b}}return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;c="";for(d in this.geometryIndex){for(a=this.geometryIndex[d],c+="object {\n",c+="  noinstance\n",c+="  type generic-mesh\n",c+="  name "+d+"\n",c+="  points "+a.geometry.vertices.length+"\n",n=a.geometry.vertices,f=0,j=n.length;j>f;f++)e=n[f],c+="    "+this.exportVector(e)+"\n";for(c+="  triangles "+a.geometry.faces.length+"\n",o=a.geometry.faces,g=0,k=o.length;k>g;g++)b=o[g],c+="    "+this.exportFace(b)+"\n";if(this.faceNormals){for(c+="  normals facevarying\n",c+="    ",p=a.geometry.faces,h=0,l=p.length;l>h;h++)b=p[h],c+=this.exportVector(b.normal)+" ";c+="\n"}else c+=this.vertexNormals?"  normals none\n":"  normals none\n";if(c+="  uvs none\n",a.faceMaterials)for(c+="  face_shaders\n",q=a.geometry.faces,i=0,m=q.length;m>i;i++)b=q[i],c+="    "+b.materialIndex+"\n";c+="}\n\n"}return c},b}(b),i=function(a){function b(){this.type=b.TYPES[0],this.enabled=!1,this.globalMapTypes=b.GLOBAL_MAP_TYPES,this.types=b.TYPES,this.irrCache={samples:512,tolerance:.01,spacingMin:.05,spacingMax:5,globalEnabled:!1,globalPhotons:1e4,globalMap:b.GLOBAL_MAP_TYPES[0],globalEstimate:100,globalRadius:.75},this.igi={samples:64,sets:1,bias:.01,biasSamples:0},this.path={samples:32},this.ambOcc={samples:32,bright:16777215,dark:0,maxDistance:3},this.fake={up:new THREE.Vector3(0,1,0),sky:0,ground:16777215}}return x(b,a),b.GLOBAL_MAP_TYPES=["grid","path"],b.TYPES=["igi","irr-cache","path","ambocc","fake"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(b+="gi {\n",b+="  type "+this.type+"\n","igi"===this.type?(b+="  samples "+this.igi.samples+"\n",b+="  sets "+this.igi.sets+"\n",b+="  b "+this.igi.bias+"\n",b+="  bias-samples "+this.igi.biasSamples+"\n"):"irr-cache"===this.type?(b+="  samples "+this.irrCache.samples+"\n",b+="  tolerance "+this.irrCache.tolerance+"\n",b+="  spacing "+this.irrCache.spacingMin+" "+this.irrCache.spacingMax+"\n",this.irrCache.globalEnabled&&(a="  global ",a+=this.irrCache.globalPhotons+" ",a+=this.irrCache.globalMap+" ",a+=this.irrCache.globalEstimate+" ",a+=this.irrCache.globalRadius+"\n",b+=a)):"path"===this.type?b+="  samples "+this.path.samples+"\n":"ambocc"===this.type?(b+='  bright { "sRGB nonlinear" 1 1 1 }\n',b+='  dark { "sRGB nonlinear" 0 0 0 }\n',b+="  samples "+this.ambOcc.samples+"\n",b+="  maxdist "+this.ambOcc.maxDistance+"\n"):"fake"===this.type&&(b+="  up "+this.exportVector(this.fake.up+"\n"),b+='  sky { "sRGB nonlinear" 0 0 0 }\n',b+='  ground { "sRGB nonlinear" 1 1 1 }\n'),b+="}\n\n"):b},b}(b),k=function(a){function b(){b.__super__.constructor.call(this),this.resolutionX=800,this.resolutionY=600,this.antialiasMin=-1,this.antialiasMax=1,this.samples=2,this.contrast=.1,this.filter=b.FILTERS[0],this.jitter=!0,this.filterTypes=b.FILTERS}return x(b,a),b.FILTERS=["box","triangle","gaussian","mitchell","catmull-rom","blackman-harris","sinc","lanczos","ospline"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",a+="image {\n",a+="  resolution "+this.resolutionX+" "+this.resolutionY+"\n",a+="  aa "+this.antialiasMin+" "+this.antialiasMax+"\n",a+="  samples "+this.samples+"\n",a+="  contrast "+this.contrast+"\n",a+="  filter "+this.filter+"\n",a+="  jitter "+this.jitter+"\n",a+="}\n\n"},b}(b),l=function(a){function b(){b.__super__.constructor.call(this),this.lightIndex={}}return x(b,a),b.prototype.addToIndex=function(a){var b;return b=this.lightIndex[a.uuid],!b&&a instanceof THREEFLOW.SunskyLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.PointLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.AreaLight&&(this.lightIndex[a.uuid]=a),null},b.prototype.doTraverse=function(a){return a instanceof THREEFLOW.PointLight?!1:a instanceof THREEFLOW.SunskyLight?!1:a instanceof THREEFLOW.AreaLight?!1:!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l;d="";for(e in this.lightIndex)if(b=this.lightIndex[e],b instanceof THREEFLOW.SunskyLight)d+="light {\n",d+="  type sunsky\n",d+="  up "+this.exportVector(b.up)+"\n",d+="  east "+this.exportVector(b.east)+"\n",d+="  sundir "+this.exportVector(b.direction)+"\n",d+="  turbidity "+b.turbidity+"\n",d+="  samples "+b.samples+"\n",d+="}\n\n";else if(b instanceof THREEFLOW.PointLight)d+="light {\n",d+="  type point\n",d+="  color "+this.exportColorTHREE(b.color)+"\n",d+="  power "+b.power+" \n",d+="  p "+this.exportVector(b.position)+"\n",d+="}\n\n";else if(b instanceof THREEFLOW.AreaLight){for(d+="light {\n",d+="  type meshlight\n",d+="  name "+b.uuid+"\n",d+="  emit "+this.exportColorTHREE(b.color)+"\n",d+="  radiance "+b.radiance+" \n",d+="  samples "+b.samples+" \n",d+="  points "+b.geometry.vertices.length+"\n",c=b.matrixWorld,k=b.geometry.vertices,g=0,i=k.length;i>g;g++)f=k[g],f=f.clone(),f.applyMatrix4(c),d+="    "+this.exportVector(f)+"\n";for(d+="  triangles "+b.geometry.faces.length+"\n",l=b.geometry.faces,h=0,j=l.length;j>h;h++)a=l[h],d+="    "+this.exportFace(a)+"\n";d+="}\n\n"}return d},b}(b),m=function(a){function b(){b.__super__.constructor.call(this),this.materialsIndex={}}return x(b,a),b.prototype.addToIndex=function(a){var b,c,d,e;if(a instanceof THREE.Mesh)if(a.material instanceof THREE.MeshFaceMaterial)for(e=a.material.materials,c=0,d=e.length;d>c;c++)b=e[c],this.materialsIndex[b.uuid]||(this.materialsIndex[b.uuid]=b);else a.material&&!this.materialsIndex[a.material.uuid]&&(this.materialsIndex[a.material.uuid]=a.material);return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c;b="";for(c in this.materialsIndex)a=this.materialsIndex[c],b+="shader {\n",b+="  name "+a.uuid+"\n",a instanceof THREEFLOW.ConstantMaterial||a instanceof THREE.MeshBasicMaterial?(b+="  type constant\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.DiffuseMaterial||a instanceof THREE.MeshLambertMaterial?(b+="  type diffuse\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.ShinyMaterial?(b+="  type shiny\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  refl "+a.reflection+"\n"):a instanceof THREEFLOW.GlassMaterial?(b+="  type glass\n",b+="  eta "+a.eta+"\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.MirrorMaterial?(b+="  type mirror\n",b+="  refl "+this.exportColorTHREE(a.reflection)+"\n"):(a instanceof THREEFLOW.PhongMaterial||a instanceof THREE.MeshPhongMaterial)&&(b+="  type phong\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  spec "+this.exportColorTHREE(a.specular)+" "+a.shininess+"\n",b+="  samples "+(a.samples||4)+"\n"),b+="}\n\n";return b},b}(b),n=function(a){function b(){b.__super__.constructor.call(this),this.convertPrimitives=!0,this.meshIndex={}}return x(b,a),b.prototype.addToIndex=function(a){return a instanceof THREE.Mesh&&!this.meshIndex[a.uuid]&&(this.meshIndex[a.uuid]=a),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g;c="";for(d in this.meshIndex){if(b=this.meshIndex[d],b.geometry instanceof THREEFLOW.InfinitePlaneGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type plane\n",c+="  p "+this.exportTransformPosition(b)+"\n",c+="  n "+this.exportVector(b.up)+"\n";else if(this.convertPrimitives&&b.geometry instanceof THREE.SphereGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type sphere\n",c+="  name "+b.uuid+"\n",c+="  c "+this.exportTransformPosition(b)+"\n",c+="  r "+b.geometry.radius+"\n";else if(b.material instanceof THREE.MeshFaceMaterial)for(c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shaders "+b.material.materials.length+"\n",g=b.material.materials,e=0,f=g.length;f>e;e++)a=g[e],c+="    "+a.uuid+"\n";else c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shader "+b.material.uuid+"\n";c+="}\n\n"}return c},b}(b),u=function(a){function b(){b.__super__.constructor.call(this),this.enabled=!1,this.diffusion=1,this.reflection=4,this.refraction=4}return x(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="trace-depths {\n",a+="  diff "+this.diffusion+"\n",a+="  refl "+this.reflection+"\n",a+="  refr "+this.refraction+"\n",a+="}\n\n"):a},b}(b),THREEFLOW.InfinitePlaneGeometry=function(a,b,c,d){var e,f,g,h,i,j;for(a=a||1e3,b=b||1e3,c=c||10,d=d||10,THREE.PlaneGeometry.call(this,a,b,c,d),f=new THREE.Matrix4,f.makeRotationX(Math.PI/2),this.applyMatrix(f),g=new THREE.Vector3(0,1,0),j=this.faces,h=0,i=j.length;i>h;h++)e=j[h],e.normal.copy(g),e.vertexNormals[0].copy(g),e.vertexNormals[1].copy(g),e.vertexNormals[2].copy(g);return this.computeCentroids()},THREEFLOW.InfinitePlaneGeometry.prototype=Object.create(THREE.PlaneGeometry.prototype),THREEFLOW.AreaLight=a=function(){function a(a){var b;null==a&&(a={}),THREE.Object3D.call(this),a.simulate!==!1&&(this.simulate=!0),a.markers!==!1&&(this.markers=!0),this._color=new THREE.Color(a.color),this._radiance=a.radiance||100,this.samples=a.samples||16,this.geometry=a.geometry||new THREE.PlaneGeometry(10,10),this.markers&&(b=new THREE.MeshBasicMaterial({wireframe:!0}),b.color=this._color,this.mesh=new THREE.Mesh(this.geometry,b),this.add(this.mesh)),this.simulate&&(this.light=new THREE.PointLight(a.color,a.intensity),this.light.color=this._color,this.add(this.light))}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a}},radiance:{get:function(){return this._radiance},set:function(a){return this._radiance=a}}}),a}(),THREEFLOW.PointLight=q=function(){function a(a){var b,c,d;null==a&&(a={}),THREE.Object3D.call(this),a.simulate!==!1&&(this.simulate=!0),a.markers!==!1&&(this.markers=!0),this._color=new THREE.Color(a.color),this._power=a.power||100,this.markers&&(c=a.markerSize||1,b=new THREE.SphereGeometry(c,3,3),d=new THREE.MeshBasicMaterial({wireframe:!0}),d.color=this._color,this.mesh=new THREE.Mesh(b,d),this.add(this.mesh)),this.simulate&&(this.light=new THREE.PointLight(a.color,a.intensity,a.distance),this.light.color=this._color,this.add(this.light))}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a}},power:{get:function(){return this._power},set:function(a){return this._power=a}}}),a}(),THREEFLOW.SunskyLight=t=function(){function a(a){THREE.Object3D.call(this),a=a||{},this.up=a.up||new THREE.Vector3(0,1,0),this.east=a.east||new THREE.Vector3(0,0,1),this.direction=a.direction||new THREE.Vector3(1,1,1),this.turbidity=a.turbidity||2,this.samples=a.samples||32,a.simulate!==!1&&(a.simulate=!0),a.dirLight!==!1&&(a.dirLight=!0),a.hemLight!==!1&&(a.hemLight=!0),a.simulate&&(a.dirLight&&(this.dirLight=new THREE.DirectionalLight(16777215,1),this.add(this.dirLight)),a.hemLight&&(this.hemLight=new THREE.HemisphereLight(16777215,3355443,.8),this.add(this.hemLight)))}return a.prototype=Object.create(THREE.Object3D.prototype),a}(),THREEFLOW.ConstantMaterial=e=function(){function a(a){null==a&&(a={}),THREE.MeshBasicMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshBasicMaterial.prototype),a}(),THREEFLOW.DiffuseMaterial=f=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),THREE.MeshLambertMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshLambertMaterial.prototype),a}(),THREEFLOW.GlassMaterial=j=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.eta&&(a.eta=1),this.eta=a.eta,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.MirrorMaterial=o=function(){function a(a){null==a&&(a={}),a.color=void 0===a.reflection&&void 0===a.color?16777215:void 0===a.reflection?a.color:void 0===a.color?a.reflection:16777215,THREE.MeshPhongMaterial.call(this),this.setValues(a),this.reflection=this.color}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.PhongMaterial=p=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.power&&(this.power=100),void 0===a.samples&&(this.samples=4),THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.ShinyMaterial=r=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.reflection&&(a.reflection=.5),this.reflection=a.reflection,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}()}).call(this);