(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=function(a,b){return function(){return a.apply(b,arguments)}},E={}.hasOwnProperty,F=function(a,b){function c(){this.constructor=a}for(var d in b)E.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};window.THREEFLOW=window.THREEFLOW||{},THREEFLOW.SunflowRenderer=A=function(){function a(a){this.onRenderError=D(this.onRenderError,this),this.onRenderComplete=D(this.onRenderComplete,this),this.onRenderProgress=D(this.onRenderProgress,this),this.onRenderStart=D(this.onRenderStart,this),this.onConnected=D(this.onConnected,this),a=a||{},this.pngPath=a.pngPath||null,this.scPath=a.scPath||null,this.scSave=a.scSave||!1,this.scale=a.scale||1,this.exporter=new i,this.image=this.exporter.image,this.bucket=this.exporter.bucket,this.traceDepths=this.exporter.traceDepths,this.caustics=this.exporter.caustics,this.gi=this.exporter.gi,this.cameras=this.exporter.cameras,this.lights=this.exporter.lights,this.materials=this.exporter.materials,this.geometry=this.exporter.geometry,this.bufferGeometry=this.exporter.bufferGeometry,this.meshes=this.exporter.meshes,this.connectionStatus="",this.connected=!1,this.rendering=!1,this.onRenderStatus=new THREEFLOW.Signal,this.onConnectionStatus=new THREEFLOW.Signal}return a.CONNECTING="connecting",a.CONNECTED="connected",a.ERROR="error",a.RENDER_START="render-start",a.RENDER_PROGRESS="render-progress",a.RENDER_COMPLETE="render-complete",a.RENDER_ERROR="render-error",a.prototype.connect=function(){return this.connected?void 0:(this.onConnectionStatus.dispatch(a.CONNECTING),this.socket=io.connect(this.host),console.log(this.socket),this.socket.on("connected",this.onConnected),this.socket.on("render-start",this.onRenderStart),this.socket.on("render-progress",this.onRenderProgress),this.socket.on("render-complete",this.onRenderComplete),this.socket.on("render-error",this.onRenderError),null)},a.prototype.render=function(b,c,d,e){var f;if(!this.connected)throw new Error("[SunflowRenderer] Call connect() before rendering.");return this.rendering?console.log("[Render in Progress]"):(this.rendering=!0,this.onConnectionStatus.dispatch(a.CONNECTING),this.exporter.image.resolutionX=d*this.scale,this.exporter.image.resolutionY=e*this.scale,this.exporter.indexScene(b),f=this.exporter.exportCode(),this.socket.emit("render",{scContents:f,scPath:this.scPath,scSave:this.scSave,pngPath:this.pngPath})),null},a.prototype.onConnected=function(){return console.log("THREEFLOW "+THREEFLOW.VERSION+" [Connected]"),this.connected=!0,this.onConnectionStatus.dispatch(Sunf),null},a.prototype.onRenderStart=function(){return console.log("onRenderStart"),null},a.prototype.onRenderProgress=function(a){return console.log("onRenderProgress",a),null},a.prototype.onRenderComplete=function(a){return this.rendering=!1,console.log("onRenderComplete",a),null},a.prototype.onRenderError=function(a){return this.rendering=!1,console.log("onRenderError",a),null},a}(),THREEFLOW.VERSION="0.6.0.1",THREEFLOW.COMMIT="c8d7f10",b=function(){function a(a){this.exporter=a}return a.prototype.addToIndex=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.doTraverse=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportBlock=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportColorTHREE=function(a){return'{ "sRGB nonlinear" '+a.r+" "+a.g+" "+a.b+" }"},a.prototype.exportColorHex=function(a){var b,c,d;return d=(a>>16&255)/255,c=(a>>8&255)/255,b=(255&a)/255,'{ "sRGB nonlinear" '+d+" "+c+" "+b+" }"},a.prototype.exportVector=function(a){return a.x+" "+a.y+" "+a.z},a.prototype.exportFace=function(a){return a.a+" "+a.b+" "+a.c},a.prototype.exportTransform=function(a){var b,c,d,e,f;for(c="",f=a.matrixWorld.elements,d=0,e=f.length;e>d;d++)b=f[d],c+=" "+b;return c},a.prototype.exportTransformPosition=function(a){var b,c;return c="",b=a.matrixWorld.elements,c+=b[12]+" "+b[13]+" "+b[14]},a}(),c=function(a){function b(a){b.__super__.constructor.call(this,a),this.orderTypes=b.ORDER_TYPES,this.enabled=!0,this.reverse=!1,this.size=64,this.order=this.orderTypes[0]}return F(b,a),b.ORDER_TYPES=["hilbert","spiral","column","row","diagonal","random"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(a=this.size+" ",a+=this.reverse?'"reverse '+this.order+'"':this.order,b+="bucket "+a+"\n"):b},b}(b),d=function(a){function b(a){b.__super__.constructor.call(this,a),this.normals=!0,this.uvs=!1,this.bufferGeometryIndex={}}return F(b,a),b.prototype.addToIndex=function(a){return!a instanceof THREE.Mesh?void 0:(a.geometry instanceof THREE.BufferGeometry&&!this.bufferGeometryIndex[a.geometry.uuid]&&(this.bufferGeometryIndex[a.geometry.uuid]={geometry:a.geometry,faceMaterials:!1}),null)},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;k="";for(n in this.bufferGeometryIndex){for(b=this.bufferGeometryIndex[n],k+="object {\n",k+="  noinstance\n",k+="  type generic-mesh\n",k+="  name "+n+"\n",i=b.geometry.offsets,a=b.geometry.attributes,j=a.position.array,g=a.normal.array,k+="  points "+j.length/3+"\n",d=o=0,x=j.length;x>o;d=o+=3)k+="    "+j[d]+" "+j[d+1]+" "+j[d+2]+"\n";if(a.index)if(f=a.index.array,i.length){for(m=0,l="",p=0,s=i.length;s>p;p++)for(h=i[p],e=h.index,d=q=y=h.start,z=h.start+h.count;z>q;d=q+=3)m++,l+="    "+(f[d]+e)+" "+(f[d+1]+e)+" "+(f[d+2]+e)+"\n";k+="  triangles "+m+"\n",k+=l}else for(k+="  triangles "+f.length/3+"\n",d=r=0,A=f.length;A>r;d=r+=3)k+="    "+f[d]+" "+f[d+1]+" "+f[d+2]+"\n";else for(k+="  triangles "+j.length/9+"\n",d=u=0,B=j.length/3;B>u;d=u+=3)k+="    "+d+" "+(d+1)+" "+(d+2)+"\n";if(this.normals&&g.length>0){for(k+="  normals vertex\n",d=v=0,C=g.length;C>v;d=v+=3)k+="    "+g[d]+" "+g[d+1]+" "+g[d+2]+"\n";k+="\n"}else k+="  normals none\n";if(k+=this.uvs?"  uvs none\n":"  uvs none\n",b.faceMaterials)for(k+="  face_shaders\n",D=b.geometry.faces,w=0,t=D.length;t>w;w++)c=D[w],k+="    "+c.materialIndex+"\n";k+="}\n\n"}return k},b}(b),e=function(a){function b(a){b.__super__.constructor.call(this,a),this.helperVec=new THREE.Vector3,this.camera=null}return F(b,a),b.prototype.addToIndex=function(a){return this.camera?void 0:(a instanceof THREE.PerspectiveCamera&&(this.camera=a,console.log("SET CAMERA",this.camera)),null)},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.camera?(a+="camera {\n",a+="  type pinhole\n",this.helperVec.copy(this.camera.position),this.helperVec.applyMatrix4(this.camera.matrixWorld),a+="  eye "+this.exportVector(this.camera.position)+"\n",this.helperVec.set(0,0,-1),this.helperVec.applyMatrix4(this.camera.matrixWorld),a+="  target "+this.exportVector(this.helperVec)+"\n",a+="  up "+this.exportVector(this.camera.up)+"\n",a+="  fov "+this.camera.fov*this.camera.aspect+"\n",a+="  aspect "+this.camera.aspect+"\n",a+="}\n\n"):a},b}(b),f=function(a){function b(a){b.__super__.constructor.call(this,a),this.enabled=!1,this.photons=1e4,this.kdEstimate=100,this.kdRadius=.5}return F(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="photons {\n",a+="  caustics "+this.photons+" kd "+this.kdEstimate+" "+this.kdRadius+"\n",a+="}\n\n"):a},b}(b),i=function(){function a(){this.exporterSettings={convertPrimitives:!1},this.blockExporters=[],this.image=this.addBlockExporter(new m(this)),this.bucket=this.addBlockExporter(new c(this)),this.traceDepths=this.addBlockExporter(new C(this)),this.caustics=this.addBlockExporter(new f(this)),this.gi=this.addBlockExporter(new k(this)),this.cameras=this.addBlockExporter(new e(this)),this.lights=this.addBlockExporter(new r(this)),this.materials=this.addBlockExporter(new s(this)),this.geometry=this.addBlockExporter(new j(this)),this.bufferGeometry=this.addBlockExporter(new d(this)),this.meshes=this.addBlockExporter(new t(this))}return a.prototype.addBlockExporter=function(a){if(!a instanceof b)throw new Error("Extend BlockExporter");return this.blockExporters.push(a),a},a.prototype.indexScene=function(a){var b,c,d,e,f,g,h,i,j;if(a.children.length)for(i=a.children,e=0,g=i.length;g>e;e++){for(c=i[e],d=!0,j=this.blockExporters,f=0,h=j.length;h>f;f++)b=j[f],b.addToIndex(c),d=d&&b.doTraverse(c);d&&this.indexScene(c)}return null},a.prototype.exportCode=function(){var a,b,c,d,e;for(b="",e=this.blockExporters,c=0,d=e.length;d>c;c++)a=e[c],b+=a.exportBlock();return b},a}(),j=function(a){function b(a){b.__super__.constructor.call(this,a),this.normals=!0,this.vertexNormals=!1,this.uvs=!1,this.geometryIndex={}}return F(b,a),b.prototype.addToIndex=function(a){var b;if(!(!a instanceof THREE.Mesh||a instanceof THREE.VertexNormalsHelper)){if(a.geometry instanceof THREE.Geometry){if(a.geometry instanceof THREEFLOW.InfinitePlaneGeometry)return;b=a.material instanceof THREE.MeshFaceMaterial,this.geometryIndex[a.geometry.uuid]?!this.geometryIndex[a.geometry.uuid].faceMaterials&&b&&(this.geometryIndex[a.geometry.uuid].faceMaterials=!0):this.geometryIndex[a.geometry.uuid]={geometry:a.geometry,faceMaterials:b}}return null}},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;e="";for(f in this.geometryIndex){for(a=this.geometryIndex[f],e+="object {\n",e+="  noinstance\n",e+="  type generic-mesh\n",e+="  name "+f+"\n",e+="  points "+a.geometry.vertices.length+"\n",w=a.geometry.vertices,k=0,o=w.length;o>k;k++)j=w[k],e+="    "+this.exportVector(j)+"\n";for(e+="  triangles "+a.geometry.faces.length+"\n",x=a.geometry.faces,l=0,p=x.length;p>l;l++)b=x[l],e+="    "+this.exportFace(b)+"\n";if(this.normals&&this.vertexNormals){for(d=[],y=a.geometry.faces,m=0,q=y.length;q>m;m++)b=y[m],d[b.a]=b.vertexNormals[0],d[b.b]=b.vertexNormals[1],d[b.c]=b.vertexNormals[2];if(d.length>0&&d.length===a.geometry.vertices.length){for(e+="  normals vertex\n",n=0,r=d.length;r>n;n++)c=d[n],e+="    "+c.x+" "+c.y+" "+c.z+"\n";e+="\n"}else console.log("[Threeflow] Problem with geometry normals. ",a.geometry),e+="  normals none\n"}else if(this.normals&&!this.vertexNormals)for(e+="  normals facevarying\n",z=a.geometry.faces,u=0,s=z.length;s>u;u++)b=z[u],g=b.vertexNormals[0],h=b.vertexNormals[1],i=b.vertexNormals[2],e+="    "+g.x+" "+g.y+" "+g.z+" "+h.x+" "+h.y+" "+h.z+" "+i.x+" "+i.y+" "+i.z+"\n";else e+="  normals none\n";if(e+=this.uvs?"  uvs none\n":"  uvs none\n",a.faceMaterials)for(e+="  face_shaders\n",A=a.geometry.faces,v=0,t=A.length;t>v;v++)b=A[v],e+="    "+b.materialIndex+"\n";e+="}\n\n"}return e},b}(b),k=function(a){function b(a){b.__super__.constructor.call(this,a),this.type=b.TYPES[0],this.enabled=!1,this.globalMapTypes=b.GLOBAL_MAP_TYPES,this.types=b.TYPES,this.irrCache={samples:512,tolerance:.01,spacingMin:.05,spacingMax:5,globalEnabled:!1,globalPhotons:1e4,globalMap:b.GLOBAL_MAP_TYPES[0],globalEstimate:100,globalRadius:.75},this.igi={samples:64,sets:1,bias:.01,biasSamples:0},this.path={samples:32},this.ambOcc={samples:32,bright:16777215,dark:0,maxDistance:3},this.fake={up:new THREE.Vector3(0,1,0),sky:10526959,ground:15724527}}return F(b,a),b.GLOBAL_MAP_TYPES=["grid","path"],b.TYPES=["igi","irr-cache","path","ambocc","fake"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(b+="gi {\n",b+="  type "+this.type+"\n","igi"===this.type?(b+="  samples "+this.igi.samples+"\n",b+="  sets "+this.igi.sets+"\n",b+="  b "+this.igi.bias+"\n",b+="  bias-samples "+this.igi.biasSamples+"\n"):"irr-cache"===this.type?(b+="  samples "+this.irrCache.samples+"\n",b+="  tolerance "+this.irrCache.tolerance+"\n",b+="  spacing "+this.irrCache.spacingMin+" "+this.irrCache.spacingMax+"\n",this.irrCache.globalEnabled&&(a="  global ",a+=this.irrCache.globalPhotons+" ",a+=this.irrCache.globalMap+" ",a+=this.irrCache.globalEstimate+" ",a+=this.irrCache.globalRadius+"\n",b+=a)):"path"===this.type?b+="  samples "+this.path.samples+"\n":"ambocc"===this.type?(b+='  bright { "sRGB nonlinear" 1 1 1 }\n',b+='  dark { "sRGB nonlinear" 0 0 0 }\n',b+="  samples "+this.ambOcc.samples+"\n",b+="  maxdist "+this.ambOcc.maxDistance+"\n"):"fake"===this.type&&(b+="  up "+this.exportVector(this.fake.up)+"\n",b+="  sky "+this.exportColorHex(this.fake.sky)+"\n",b+="  ground "+this.exportColorHex(this.fake.ground)+"\n"),b+="}\n\n"):b},b}(b),m=function(a){function b(a){b.__super__.constructor.call(this,a),this.resolutionX=800,this.resolutionY=600,this.antialiasMin=-1,this.antialiasMax=1,this.samples=2,this.contrast=.1,this.filter=b.FILTERS[0],this.jitter=!0,this.filterTypes=b.FILTERS}return F(b,a),b.FILTERS=["box","triangle","gaussian","mitchell","catmull-rom","blackman-harris","sinc","lanczos","ospline"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",a+="image {\n",a+="  resolution "+this.resolutionX+" "+this.resolutionY+"\n",a+="  aa "+this.antialiasMin+" "+this.antialiasMax+"\n",a+="  samples "+this.samples+"\n",a+="  contrast "+this.contrast+"\n",a+="  filter "+this.filter+"\n",a+="  jitter "+this.jitter+"\n",a+="}\n\n"},b}(b),r=function(a){function b(a){b.__super__.constructor.call(this,a),this.override={samples:{enabled:!1,value:64}},this.helperVec=new THREE.Vector3,this.lightIndex={}}return F(b,a),b.prototype.addToIndex=function(a){var b;return b=this.lightIndex[a.uuid],!b&&a instanceof THREEFLOW.SunskyLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.PointLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.AreaLight&&(this.lightIndex[a.uuid]=a),null},b.prototype.doTraverse=function(a){return a instanceof THREEFLOW.PointLight?!1:a instanceof THREEFLOW.SunskyLight?!1:a instanceof THREEFLOW.AreaLight?!1:!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k;c="";for(d in this.lightIndex)if(b=this.lightIndex[d],b instanceof THREEFLOW.SunskyLight)c+="light {\n",c+="  type sunsky\n",c+="  up "+this.exportVector(b.up)+"\n",c+="  east "+this.exportVector(b.east)+"\n",c+="  sundir "+this.exportVector(b.direction)+"\n",c+="  turbidity "+b.turbidity+"\n",c+=this.override.samples.enabled?"  samples "+this.override.samples.value+"\n":"  samples "+b.samples+"\n",c+="}\n\n";else if(b instanceof THREEFLOW.PointLight)c+="light {\n",c+="  type point\n",c+="  color "+this.exportColorTHREE(b.color)+"\n",c+="  power "+b.power+" \n",c+="  p "+this.exportVector(b.position)+"\n",c+="}\n\n";else if(b instanceof THREEFLOW.AreaLight){for(c+="light {\n",c+="  type meshlight\n",c+="  name "+b.uuid+"\n",c+="  emit "+this.exportColorTHREE(b.color)+"\n",c+="  radiance "+b.radiance+" \n",c+=this.override.samples.enabled?"  samples "+this.override.samples.value+"\n":"  samples "+b.samples+"\n",c+="  points "+b.geometry.vertices.length+"\n",j=b.geometry.vertices,f=0,h=j.length;h>f;f++)e=j[f],this.helperVec.copy(e),this.helperVec.applyMatrix4(b.matrixWorld),c+="    "+this.exportVector(this.helperVec)+"\n";for(c+="  triangles "+b.geometry.faces.length+"\n",k=b.geometry.faces,g=0,i=k.length;i>g;g++)a=k[g],c+="    "+this.exportFace(a)+"\n";c+="}\n\n"}return c},b}(b),s=function(a){function b(a){b.__super__.constructor.call(this,a),this.materialsIndex={}}return F(b,a),b.prototype.addToIndex=function(a){var b,c,d,e;if(a instanceof THREE.Mesh)if(a.material instanceof THREE.MeshFaceMaterial)for(e=a.material.materials,c=0,d=e.length;d>c;c++)b=e[c],this.materialsIndex[b.uuid]||(this.materialsIndex[b.uuid]=b);else a.material&&!this.materialsIndex[a.material.uuid]&&(this.materialsIndex[a.material.uuid]=a.material);return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c;b="";for(c in this.materialsIndex)a=this.materialsIndex[c],b+="shader {\n",b+="  name "+a.uuid+"\n",a instanceof THREEFLOW.ConstantMaterial||a instanceof THREE.MeshBasicMaterial?(b+="  type constant\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.DiffuseMaterial||a instanceof THREE.MeshLambertMaterial?(b+="  type diffuse\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.ShinyMaterial?(b+="  type shiny\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  refl "+a.reflection+"\n"):a instanceof THREEFLOW.GlassMaterial?(b+="  type glass\n",b+="  eta "+a.eta+"\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.MirrorMaterial?(b+="  type mirror\n",b+="  refl "+this.exportColorTHREE(a.reflection)+"\n"):(a instanceof THREEFLOW.PhongMaterial||a instanceof THREE.MeshPhongMaterial)&&(b+="  type phong\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  spec "+this.exportColorTHREE(a.specular)+" "+a.shininess+"\n",b+="  samples "+(a.samples||4)+"\n"),b+="}\n\n";return b},b}(b),t=function(a){function b(a){b.__super__.constructor.call(this,a),this.convertPrimitives=!0,this.meshIndex={}}return F(b,a),b.prototype.addToIndex=function(a){return a instanceof THREE.Mesh&&!(a instanceof THREE.VertexNormalsHelper)?(this.meshIndex[a.uuid]||(this.meshIndex[a.uuid]=a),null):void 0},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g;c="";for(d in this.meshIndex){if(b=this.meshIndex[d],b.geometry instanceof THREEFLOW.InfinitePlaneGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type plane\n",c+="  p "+this.exportTransformPosition(b)+"\n",c+="  n "+this.exportVector(b.up)+"\n";else if(this.convertPrimitives&&b.geometry instanceof THREE.SphereGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type sphere\n",c+="  name "+b.uuid+"\n",c+="  c "+this.exportTransformPosition(b)+"\n",c+="  r "+b.geometry.radius+"\n";else if(b.material instanceof THREE.MeshFaceMaterial)for(c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shaders "+b.material.materials.length+"\n",g=b.material.materials,e=0,f=g.length;f>e;e++)a=g[e],c+="    "+a.uuid+"\n";else c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shader "+b.material.uuid+"\n";c+="}\n\n"}return c},b}(b),C=function(a){function b(a){b.__super__.constructor.call(this,a),this.enabled=!1,this.diffusion=1,this.reflection=1,this.refraction=1}return F(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="trace-depths {\n",a+="  diff "+this.diffusion+"\n",a+="  refl "+this.reflection+"\n",a+="  refr "+this.refraction+"\n",a+="}\n\n"):a},b}(b),THREEFLOW.InfinitePlaneGeometry=function(a,b,c,d){var e,f,g,h,i,j;for(a=a||1e3,b=b||1e3,c=c||10,d=d||10,THREE.PlaneGeometry.call(this,a,b,c,d),f=new THREE.Matrix4,f.makeRotationX(Math.PI/2),this.applyMatrix(f),g=new THREE.Vector3(0,1,0),j=this.faces,h=0,i=j.length;i>h;h++)e=j[h],e.normal.copy(g),e.vertexNormals[0].copy(g),e.vertexNormals[1].copy(g),e.vertexNormals[2].copy(g);return this.computeCentroids()},THREEFLOW.InfinitePlaneGeometry.prototype=Object.create(THREE.PlaneGeometry.prototype),THREEFLOW.LightingRigGui=p=function(){function a(a){var b,c,d,e;for(this.rig=a,this.gui=new dat.GUI,this.backdropFolder=this.gui.addFolder("Backdrop"),this.backdropFolder.add(this.rig.backdropMaterial,"wireframe"),this.backdropFolder.add(this.rig.backdropMaterial,"transparent"),this.backdropFolder.add(this.rig.backdropMaterial,"opacity",0,1),this.backdropFolder.open(),e=this.rig.lights,c=0,d=e.length;d>c;c++)b=e[c],this.addRigLight(b)}return a.prototype.addRigLight=function(a){var b,c;return b=this.gui.addFolder(a.name),b.add(a,"enabled"),c={yaw:a.yaw*(180/Math.PI),pitch:a.pitch*(180/Math.PI)},b.add(c,"yaw",0,360).onChange(function(b){return c.yaw=b,a.yaw=b*(Math.PI/180)}),b.add(c,"pitch",0,360).onChange(function(b){return c.pitch=b,a.pitch=b*(Math.PI/180)}),b.add(a,"distance",300,2e3),b.addColor(a,"color").onChange(function(a){var b;return b=parseInt(a,16),console.log(b)}),b.add(a,"radiance",0,100),b.add(a,"geometryType",THREEFLOW.LightingRigLight.LIGHT_GEOMETRY_TYPES),null},a}(),THREEFLOW.RendererGui=x=function(){function a(a){var b,c,d,e=this;if(this.renderer=a,this._onRender=D(this._onRender,this),!window.dat&&!window.dat.GUI)throw new Error("No dat.GUI found.");this.gui=new dat.GUI,this.onRender=null,b={version:"THREEFLOW "+THREEFLOW.VERSION,status:this.renderer.connectionStatus},this.gui.add(THREEFLOW,"VERSION").name("THREEFLOW"),this.gui.add(this.renderer,"connectionStatus"),this.gui.add(this,"_onRender").name("Render"),this.gui.add(this.renderer,"scale"),this.imageFolder=this.gui.addFolder("Image"),this.bucketFolder=this.gui.addFolder("Bucket Size/Order"),this.traceDepthsFolder=this.gui.addFolder("Trace Depths"),this.causticsFolder=this.gui.addFolder("Caustics"),this.giFolder=this.gui.addFolder("Global Illumination"),this.overridesFolder=this.gui.addFolder("Overrides"),this.otherFolder=this.gui.addFolder("Other Options"),this.imageFolder.add(this.renderer.image,"antialiasMin"),this.imageFolder.add(this.renderer.image,"antialiasMax"),this.imageFolder.add(this.renderer.image,"samples"),this.imageFolder.add(this.renderer.image,"contrast"),this.imageFolder.add(this.renderer.image,"filter",this.renderer.image.filterTypes),this.imageFolder.add(this.renderer.image,"jitter"),this.bucketFolder.add(this.renderer.bucket,"enabled"),this.bucketFolder.add(this.renderer.bucket,"size"),this.bucketFolder.add(this.renderer.bucket,"order",this.renderer.bucket.orderTypes),this.bucketFolder.add(this.renderer.bucket,"reverse"),this.traceDepthsFolder.add(this.renderer.traceDepths,"enabled"),this.traceDepthsFolder.add(this.renderer.traceDepths,"diffusion"),this.traceDepthsFolder.add(this.renderer.traceDepths,"reflection"),this.traceDepthsFolder.add(this.renderer.traceDepths,"refraction"),this.causticsFolder.add(this.renderer.caustics,"enabled"),this.causticsFolder.add(this.renderer.caustics,"photons"),this.causticsFolder.add(this.renderer.caustics,"kdEstimate"),this.causticsFolder.add(this.renderer.caustics,"kdRadius"),this.overridesFolder.add(this.renderer.lights.override.samples,"enabled").name("light_samples"),this.overridesFolder.add(this.renderer.lights.override.samples,"value").name("light_value"),this.otherFolder.add(this.renderer.meshes,"convertPrimitives"),this.otherFolder.add(this.renderer.geometry,"normals").name("geomNormals"),this.otherFolder.add(this.renderer.bufferGeometry,"normals").name("bufferGeomNormals"),this.giFolder.add(this.renderer.gi,"enabled"),this.giFolder.add(this.renderer.gi,"type",this.renderer.gi.types).onChange(function(a){return d(a)}),this.giTypes=[{type:this.renderer.gi.types[0],name:"Instant GI",property:"igi"},{type:this.renderer.gi.types[1],name:"Irradiance Caching / Final Gathering",property:"irrCache"},{type:this.renderer.gi.types[2],name:"Path Tracing",property:"path"},{type:this.renderer.gi.types[3],name:"Ambient Occlusion",property:"ambOcc"},{type:this.renderer.gi.types[4],name:"Fake Ambient Term",property:"fake"}],this.giSubFolder=null,c=function(a){var b,c,d,f,g,h,i,j;if(e.giSubFolder){for(c=e.giSubFolder.__controllers.slice(0),i=0,j=c.length;j>i;i++)b=c[i],e.giSubFolder.remove(b);e.giSubFolder.__controllers.splice(0),e.giSubFolder.__ul.firstChild.innerHTML=a.name}else e.giSubFolder=e.giFolder.addFolder(a.name);f=a.type,g=a.property;for(h in e.renderer.gi[g])"irr-cache"===f&&"globalMap"===h?e.giSubFolder.add(e.renderer.gi.irrCache,"globalMap",e.renderer.gi.globalMapTypes):"ambocc"!==f||"bright"!==h&&"dark"!==h?"fake"===f&&"up"===h?(d={upX:e.renderer.gi.fake.up.x,upY:e.renderer.gi.fake.up.y,upZ:e.renderer.gi.fake.up.z},e.giSubFolder.add(d,"upX").onChange(function(a){return this.renderer.gi.fake.up.x=a}),e.giSubFolder.add(d,"upY").onChange(function(a){return this.renderer.gi.fake.up.y=a}),e.giSubFolder.add(d,"upZ").onChange(function(a){return this.renderer.gi.fake.up.z=a})):"fake"!==f||"sky"!==h&&"ground"!==h?e.giSubFolder.add(e.renderer.gi[g],h):e.giSubFolder.addColor(e.renderer.gi.fake,h):e.giSubFolder.addColor(e.renderer.gi.ambOcc,h);return null},(d=function(a){return e.renderer.gi.type=a,c(e.giTypes[e.renderer.gi.types.indexOf(a)]),null})(this.renderer.gi.type)}return a.prototype._onRender=function(){return this.onRender?this.onRender():void 0},a}(),THREEFLOW.AreaLight=a=function(){function a(a){var b;null==a&&(a={}),THREE.Object3D.call(this),a.simulate!==!1&&(this.simulate=!0),a.markers!==!1&&(this.markers=!0),this._color=new THREE.Color(a.color),this._radiance=a.radiance||100,this.samples=a.samples||16,this._geometry=a.geometry||new THREE.PlaneGeometry(10,10),this.markers&&(this.material=new THREE.MeshBasicMaterial({wireframe:!0}),this.material.color=this._color,this.mesh=new THREE.Mesh(this._geometry,this.material),this.add(this.mesh),b=new THREE.Geometry,b.vertices.push(new THREE.Vector3(0,0,0)),b.vertices.push(new THREE.Vector3(0,0,100)),this.line=new THREE.Line(b,new THREE.LineBasicMaterial({color:this._color.getHex()})),this.add(this.line)),this.simulate&&(this.light=new THREE.PointLight(a.color,a.intensity),this.light.color=this._color,this.add(this.light))}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a}},radiance:{get:function(){return this._radiance},set:function(a){return this._radiance=a}},geometry:{get:function(){return this._geometry},set:function(a){return this._geometry!==a?(this._geometry=a,this.remove(this.mesh),this.mesh=new THREE.Mesh(this._geometry,this.material),this.add(this.mesh)):void 0}}}),a}(),THREEFLOW.PointLight=w=function(){function a(a){var b,c,d;null==a&&(a={}),THREE.Object3D.call(this),a.simulate!==!1&&(this.simulate=!0),a.markers!==!1&&(this.markers=!0),this._color=new THREE.Color(a.color),this._power=a.power||100,this.markers&&(c=a.markerSize||1,b=new THREE.SphereGeometry(c,3,3),d=new THREE.MeshBasicMaterial({wireframe:!0}),d.color=this._color,this.mesh=new THREE.Mesh(b,d),this.add(this.mesh)),this.simulate&&(this.light=new THREE.PointLight(a.color,a.intensity,a.distance),this.light.color=this._color,this.add(this.light))}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a}},power:{get:function(){return this._power},set:function(a){return this._power=a}}}),a}(),THREEFLOW.SunskyLight=B=function(){function a(a){THREE.Object3D.call(this),a=a||{},this.up=a.up||new THREE.Vector3(0,1,0),this.east=a.east||new THREE.Vector3(0,0,1),this.direction=a.direction||new THREE.Vector3(1,1,1),this.turbidity=a.turbidity||2,this.samples=a.samples||32,a.simulate!==!1&&(a.simulate=!0),a.dirLight!==!1&&(a.dirLight=!0),a.hemLight!==!1&&(a.hemLight=!0),a.simulate&&(a.dirLight&&(this.dirLight=new THREE.DirectionalLight(16777215,1),this.add(this.dirLight)),a.hemLight&&(this.hemLight=new THREE.HemisphereLight(16777215,3355443,.8),this.add(this.hemLight)))}return a.prototype=Object.create(THREE.Object3D.prototype),a}(),THREEFLOW.ConstantMaterial=g=function(){function a(a){null==a&&(a={}),THREE.MeshBasicMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshBasicMaterial.prototype),a}(),THREEFLOW.DiffuseMaterial=h=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),THREE.MeshLambertMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshLambertMaterial.prototype),a}(),THREEFLOW.GlassMaterial=l=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.eta&&(a.eta=1),this.eta=a.eta,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.MirrorMaterial=u=function(){function a(a){null==a&&(a={}),a.color=void 0===a.reflection&&void 0===a.color?16777215:void 0===a.reflection?a.color:void 0===a.color?a.reflection:16777215,THREE.MeshPhongMaterial.call(this),this.setValues(a),this.reflection=this.color}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.PhongMaterial=v=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.power&&(this.power=100),void 0===a.samples&&(this.samples=4),THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.ShinyMaterial=y=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.reflection&&(a.reflection=.5),this.reflection=a.reflection,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.LightingBox=n=function(){function a(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;null==a&&(a={}),THREE.Object3D.call(this),p=a.size||100,o=a.segments||2,l=a.scaleX||1,m=a.scaleY||1,n=a.scaleZ||1,i=a.materials||null,(!i||i.length<6)&&(j=new THREEFLOW.DiffuseMaterial({color:16711680,side:THREE.DoubleSide}),g=new THREEFLOW.DiffuseMaterial({color:65280,side:THREE.DoubleSide}),c=new THREEFLOW.DiffuseMaterial({color:255,side:THREE.DoubleSide}),t=new THREEFLOW.DiffuseMaterial({color:16776960,side:THREE.DoubleSide}),s=new THREEFLOW.DiffuseMaterial({color:16448250,side:THREE.DoubleSide}),i=[s,s,j,g,c,t]),f=new THREE.PlaneGeometry(p,p,o,o),r=new THREE.Mesh(f,i[0]),d=new THREE.Mesh(f,i[1]),h=new THREE.Mesh(f,i[2]),k=new THREE.Mesh(f,i[3]),e=new THREE.Mesh(f,i[4]),b=new THREE.Mesh(f,i[5]),q=p/2,r.position.set(0,p,0),r.rotation.x=d.rotation.x=Math.PI/2,d.position.set(0,0,0),h.position.set(-q,q,0),k.position.set(q,q,0),h.rotation.y=k.rotation.y=Math.PI/2,e.position.set(0,q,q),b.position.set(0,q,-q),this.add(r),this.add(d),this.add(h),this.add(k),this.add(e),this.add(b),this.scale.x=l,this.scale.y=m,this.scale.z=n}return a.prototype=Object.create(THREE.Object3D.prototype),a}(),THREEFLOW.LightingRig=o=function(){function a(a){var b,c,d,e;null==a&&(a={}),THREE.Object3D.call(this),this.target=a.target||new THREE.Vector3,a.backdropWall=a.backdropWall||600,a.backdropFloor=a.backdropFloor||1500,a.backdropCurve=a.backdropCurve||400,a.backdropCurveSteps=a.backdropCurveSteps||20,a.backdropMaterial=a.backdropMaterial||new THREEFLOW.DiffuseMaterial({color:15724527,ambient:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.5}),this.backdropMaterial=a.backdropMaterial,this.createBackdrop(a.backdropWall,a.backdropFloor,a.backdropCurve,a.backdropCurveSteps,a.backdropMaterial),d=5.5,c=Math.PI/2,b=Math.PI/2,e=Math.PI/180,this.lights=a.lights||[new THREEFLOW.LightingRigLight(this,{name:"Key Light",target:this.target,pitch:b-30*e,yaw:c+45*e,distance:700,light:{color:16777199,geometryType:"Plane",intensity:.5,radiance:d}}),new THREEFLOW.LightingRigLight(this,{name:"Fill Light",target:this.target,pitch:b-16*e,yaw:c-60*e,distance:700,light:{color:16777199,geometryType:"Plane",intensity:.5,radiance:d/5}}),new THREEFLOW.LightingRigLight(this,{name:"Back/Rim Light",target:new THREE.Vector3(0,0,-(a.backdropFloor/2+a.backdropCurve)),pitch:b-20*e,yaw:c+135*e,distance:900,light:{color:16777199,geometryType:"Plane",intensity:.5,radiance:d/2}}),new THREEFLOW.LightingRigLight(this,{enabled:!1,name:"Background Light",target:new THREE.Vector3(0,0,-(a.backdropFloor/2+a.backdropCurve)),pitch:b-20*e,yaw:c-120*e,distance:900,light:{color:16777199,geometryType:"Plane",intensity:.5,radiance:d/4}})],this.enabledLights=[],this.lightsDirty=!0,this.update()}return a.prototype=Object.create(THREE.Object3D.prototype),a.prototype.createBackdrop=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p;for(j=[],j.push(new THREE.Vector3),f=Math.PI/2,g=m=n=Math.PI,o=Math.PI-f,p=-(f/d);p>0?o>m:m>o;g=m+=p)k=Math.sin(g)*c+b,l=Math.cos(g)*c+c,j.push(new THREE.Vector3(k,0,l));
return j.push(new THREE.Vector3(b+c,0,c+a)),h=new THREE.LatheGeometry(j,12,0,Math.PI),i=new THREE.Mesh(h,e),i.rotation.x=-(Math.PI/2),i.position.z=b/2,this.add(i),null},a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k;if(this.lightsDirty){for(this.lightsDirty=!1,h=this.enabledLights,b=0,e=h.length;e>b;b++)a=h[b],this.remove(a);for(this.enabledLights.splice(0),i=this.lights,c=0,f=i.length;f>c;c++)a=i[c],a.enabled&&(this.add(a),this.enabledLights.push(a))}for(j=this.enabledLights,k=[],d=0,g=j.length;g>d;d++)a=j[d],k.push(a.update());return k},a}(),THREEFLOW.LightingRigLight=q=function(){function a(a,b){var c,d,e;this.rig=a,null==b&&(b={}),THREE.Object3D.call(this),this.name=b.name||"RigLight",this._enabled="boolean"==typeof b.enabled?b.enabled:!0,this.target=b.target||new THREE.Vector3,this._pitchPhi=b.pitch||0,this._yawTheta=b.yaw||0,this._distance=b.distance||500,this.rotateDirty=!0,this.lightGeomPlane=null,this.lightGeomCircle=null,this.lightGeomBox=null,this.lightGeomSphere=null,this.lightGeomRing=null,d=b.light||{},this._geometryType=d.geometryType?d.geometryType:THREEFLOW.LightingRigLight.DEFAULT_LIGHT_GEOMETRY_TYPE,d.geometry=this.getGeometry(this._geometryType),this.light=new THREEFLOW.AreaLight(d),this.add(this.light),b.bounce=b.bounce||null,"boolean"==typeof b.bounce&&(b.bounce={}),b.bounce&&(this.bouncePitchPhi=b.bounce.pitch||0,this.bounceYawTheta=b.bounce.yaw||0,e=b.bounce.material||new THREEFLOW.DiffuseMaterial({color:b.bounce.color}),c=b.bounce.geometry||new THREE.PlaneGeometry,this.bounce=new THREE.Mesh(c,e),this.add(this.bounce),this.bounceDirty=!0),this.update()}return a.LIGHT_GEOMETRY_TYPES=["Plane","Circle","Box","Sphere","Ring"],a.DEFAULT_LIGHT_GEOMETRY_TYPE="Circle",a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{yaw:{get:function(){return this._yawTheta},set:function(a){return this._yawTheta!==a?(this._yawTheta=a,this.rotateDirty=!0):void 0}},pitch:{get:function(){return this._pitchPhi},set:function(a){return this._pitchPhi!==a?(this._pitchPhi=a,this.rotateDirty=!0):void 0}},distance:{get:function(){return this._distance},set:function(a){return this._distance!==a?(this._distance=a,this.rotateDirty=!0):void 0}},color:{get:function(){return this.light.color.getHex()},set:function(a){return this.light.color.setHex(a)}},radiance:{get:function(){return this.light.radiance},set:function(a){return this.light.radiance=a}},geometryType:{get:function(){return this._geometryType},set:function(a){var b;if(this._geometryType!==a)return b=this.getGeometry(a),b?this.light.geometry=b:void 0}},enabled:{get:function(){return this._enabled},set:function(a){return this._enabled=a,this.rig?this.rig.lightsDirty=!0:void 0}}}),a.prototype.update=function(){return this.rotateDirty&&(this.rotateDirty=!1,this.light.position.x=this._distance*Math.sin(this._pitchPhi)*Math.cos(this._yawTheta),this.light.position.y=this._distance*Math.cos(this._pitchPhi),this.light.position.z=this._distance*Math.sin(this._pitchPhi)*Math.sin(this._yawTheta),this.light.lookAt(this.target),this.bounceDirty=!0),this.bounceDirty&&(this.bounceDirty=!1),null},a.prototype.getGeometry=function(a){var b;switch(b=null,a){case"Plane":null===this.lightGeomPlane&&(b=this.lightGeomPlane=new THREE.PlaneGeometry(400,400));break;case"Circle":null===this.lightGeomCircle&&(b=this.lightGeomCircle=new THREE.CircleGeometry(200,12));break;case"Box":null===this.lightGeomBox&&(b=this.lightGeomBox=new THREE.BoxGeometry(200,200,200));break;case"Sphere":null===this.lightGeomSphere&&(b=this.lightGeomSphere=new THREE.SphereGeometry(200));break;case"Ring":null===this.lightGeomRing&&(b=this.lightGeomRing=new THREE.RingGeometry(100,200,12,12))}return b},a}(),THREEFLOW.Signal=z=function(){function a(){this.listeners=null}return a.prototype.add=function(a){return this.listeners||(this.listeners=[]),this.listeners.indexOf(-1!==a)?!1:(this.listeners.push(a),!0)},a.prototype.remove=function(a){var b;return!this.listeners,b=this.listeners.indexOf(a),-1===b?!1:(this.listeners.splice(b,1),!0)},a.prototype.removeAll=function(){return this.listeners.splice(0),null},a.prototype.dispatch=function(a){var b,c,d,e;if(!this.listeners)return null;for(e=this.listeners,c=0,d=e.length;d>c;c++)(b=e[c])(a);return null},a}()}).call(this);