<!doctype html>
<html>
<head>
  <title>Threeflow</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="js/dat.gui.js"></script>

  <script src="js/three.js"></script>
  <script src="js/threeflow.js"></script>

  <script src="js/OrbitControls.js"></script>
  <script src="js/TransformControls.js"></script>

  <script src="js/BinaryLoader.js"></script>

</head>
<style>
  body{
    background-color: #131313;
    margin:0px;
    padding:0px;
    overflow:scroll;
  }
</style>
<body>
<script>

  var width, height, threeflow, lighting, gui;
  var camera, scene, renderer;

  init();
  update();

  function init() {

    // ###
    // Threeflow Basic setup

    width = 800; height = 600;

    threeflow = new THREEFLOW.SunflowRenderer({overwrite:true});
    threeflow.setSize( width,height );

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( width,height );

    THREEFLOW.__log.enabled = false;
    document.body.appendChild( renderer.domElement );
    var img = document.body.appendChild( document.createElement("img") );
    img.src = "renders/camaro.png";

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera( 35, width/height, 1, 30000 );
    camera.position.set(0,500,1000);
    camera.lookAt( new THREE.Vector3() );

    lighting = new THREEFLOW.LightingRig(camera,renderer.domElement);
    lighting.loadState('{"lights":[{"enabled":true,"color":14733805,"radiance":44.896527534198526,"geometryType":"Plane","target":{"x":-376.44834756976303,"y":211.71736342113527,"z":366.81323942907534},"light":{"x":-664.4250071441212,"y":478.66377414587737,"z":629.443786737767,"sx":0.6029171577908687,"sy":0.6029171577908687,"sz":0.6029171577908687}},{"enabled":true,"color":16777199,"radiance":25.255605381165918,"geometryType":"Plane","target":{"x":217.81041418261862,"y":102.00045449485992,"z":176.3440939438861},"light":{"x":541.9178492344969,"y":159.4022976018827,"z":508.66097585349803,"sx":1.9566650852960707,"sy":0.28606604643324796,"sz":0.7423625401435991}},{"enabled":true,"color":16777199,"radiance":25.255605381165918,"geometryType":"Plane","target":{"x":-358.9297352669099,"y":210.27904120113578,"z":-351.73002160325984},"light":{"x":-1137.3712542791613,"y":478.65381754615294,"z":-302.07500597075705,"sx":0.5251717408652797,"sy":0.5251717408652797,"sz":0.5251717408652797}},{"enabled":true,"color":13620966,"radiance":8.979305506839705,"geometryType":"Plane","target":{"x":464.54509657834546,"y":176.79129808686673,"z":-120.9868416144102},"light":{"x":984.3698177527843,"y":288.0694181623479,"z":-200.0281888937119,"sx":1.4667118305656217,"sy":0.6395090016393891,"sz":0.6395090016393891}}],"camera":{"x":-16.88461836778314,"y":186.06100677372322,"z":866.163040414001,"rx":0.021938034766455193,"rz":0.003270417346090236,"ord":"XYZ"}}')
    scene.add( lighting );

    gui = new THREEFLOW.Gui(threeflow,lighting);
    gui.onRender.add( function(){
      threeflow.render( scene, camera, "camaro" );
    });


    var mesh,material;

    var loader = new THREE.BinaryLoader();

    loader.load("/models/CamaroNoUv_bin.js",function(geometry){
      geometry.computeBoundingBox();

      var scale = 200 / ( geometry.boundingBox.max.y - geometry.boundingBox.min.y );

      var body,chrome,glass,tire,interior,black;
      body = new THREEFLOW.ShinyMaterial( {color: 0xff6600, reflection: 0.3} );
      chrome = new THREEFLOW.MirrorMaterial( {color: 0xffffff,reflection: 0xffffff} );

      // Haven't been able to get GlassMaterial rendering in a final render.
      // Gives warning "BCKT   error : Inf shading sample!" and lots of artifacts appear on render.
      // IPR preview works though.
      // So use ShinyMaterial instead.
      glass = new THREEFLOW.ShinyMaterial( {color: 0xaaaaaa, reflection: 0.6, opacity: 0.25, transparent: true } );
      //glass = new THREEFLOW.GlassMaterial( {color: 0xaaaaaa, eta:1.0, opacity: 0.25, transparent: true } );
      tire = new THREEFLOW.DiffuseMaterial( {color: 0x050505} );
      interior = new THREE.MeshPhongMaterial( { color: 0x050505, shininess: 20} );
      black = new THREE.MeshLambertMaterial( {color: 0x000000} );

      // body,wheels,grill,door lines,windshield,interior,tire,tireling,behind grill
      material = new THREE.MeshFaceMaterial([body,chrome,chrome,chrome,glass,interior,tire,black,black]);

      mesh = new THREE.Mesh(geometry,material);

      mesh.scale.set(scale,scale,scale);
      mesh.position.y = geometry.boundingBox.max.y*scale;
      mesh.rotation.y = -(Math.PI/4);

      scene.add(mesh);
    });
  }

  function update() {
    requestAnimationFrame( update );

    lighting.update();
    renderer.render( scene, camera );
  }

</script>
</body>
</html>