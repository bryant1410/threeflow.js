(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=function(a,b){return function(){return a.apply(b,arguments)}},E={}.hasOwnProperty,F=function(a,b){function c(){this.constructor=a}for(var d in b)E.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};window.THREEFLOW=window.THREEFLOW||{},THREEFLOW.SunflowRenderer=A=function(){function a(a){var b;null==a&&(a={}),this.onRenderError=D(this.onRenderError,this),this.onRenderCancelled=D(this.onRenderCancelled,this),this.onRenderComplete=D(this.onRenderComplete,this),this.onRenderProgress=D(this.onRenderProgress,this),this.onRenderStart=D(this.onRenderStart,this),this.onRenderAdded=D(this.onRenderAdded,this),this.onDisconnected=D(this.onDisconnected,this),this.onConnected=D(this.onConnected,this),THREEFLOW.log(THREEFLOW.VERSION,"/",THREEFLOW.COMMIT),b=a.autoConnect===!1?!1:!0,this.name=a.name||null,this.scale=a.scale||1,this.overwrite=a.overwrite||!1,this.deleteSc=a.deleteSc===!1?!1:!0,this.width=a.width||800,this.height=a.height||600,this.sunflowCl={noGui:!1,ipr:!0,hiPri:!1},this.exporter=new i,this.image=this.exporter.image,this.bucket=this.exporter.bucket,this.traceDepths=this.exporter.traceDepths,this.caustics=this.exporter.caustics,this.gi=this.exporter.gi,this.cameras=this.exporter.cameras,this.lights=this.exporter.lights,this.modifiers=this.exporter.modifiers,this.materials=this.exporter.materials,this.geometry=this.exporter.geometry,this.bufferGeometry=this.exporter.bufferGeometry,this.meshes=this.exporter.meshes,this.connectionStatus="",this.connected=!1,this.rendering=!1,this.onRenderStatus=new THREEFLOW.Signal,this.onConnectionStatus=new THREEFLOW.Signal,b&&this.connect()}return a.CONNECTING="connecting",a.CONNECTED="connected",a.DISCONNECTED="disconnected",a.ERROR="error",a.RENDER_ADDED="render-added",a.RENDER_START="render-start",a.RENDER_PROGRESS="render-progress",a.RENDER_CANCELLED="render-cancelled",a.RENDER_COMPLETE="render-complete",a.RENDER_ERROR="render-error",a.prototype.setSize=function(a,b){return this.width=a,this.height=b,null},a.prototype.linkTexturePath=function(a,b){return this.exporter.linkTexturePath(a,b),null},a.prototype.connect=function(){return this.connected?void 0:(this.setConnectionStatus(a.CONNECTING),this.socket=io.connect(this.host),this.socket.on("connected",this.onConnected),this.socket.on("disconnected",this.onDisconnected),this.socket.on(a.RENDER_ADDED,this.onRenderAdded),this.socket.on(a.RENDER_START,this.onRenderStart),this.socket.on(a.RENDER_PROGRESS,this.onRenderProgress),this.socket.on(a.RENDER_COMPLETE,this.onRenderComplete),this.socket.on(a.RENDER_CANCELLED,this.onRenderCancelled),this.socket.on(a.RENDER_ERROR,this.onRenderError),null)},a.prototype.render=function(b,c,d){var e,f=this;if(!this.connected)throw new Error("[Threeflow] Call connect() before rendering.");if(!c instanceof THREE.PerspectiveCamera)throw new Error("[Threeflow] Only use THREE.PerspectiveCamera.");if(isNaN(this.width)||isNaN(this.height)||isNaN(this.scale))throw new Error("[Threeflow] Error with width/height or scale.");return this.rendering?THREEFLOW.log("Render in progress."):(this.onRenderStatus.dispatch({status:a.RENDER_START}),this.rendering=!0,THREEFLOW.log("Indexing scene."),e=function(){var a;return f.name=d?d:f.name,f.exporter.clean(),f.exporter.image.resolutionX=f.width*f.scale,f.exporter.image.resolutionY=f.height*f.scale,f.exporter.camera.camera=c,f.exporter.indexObject3d(b),a=f.exporter.exportCode(),THREEFLOW.log("Sending scene file."),f.socket.emit("render",{source:a,options:{name:f.name,overwrite:f.overwrite,deleteSc:f.deleteSc},sunflowCl:f.sunflowCl})},setTimeout(e,20)),null},a.prototype.setConnectionStatus=function(a){return this.connectionStatus!==a?(this.connectionStatus=a,this.onConnectionStatus.dispatch({status:a}),null):void 0},a.prototype.onConnected=function(){return THREEFLOW.log("[Connected]"),this.connected=!0,this.rendering=!1,this.setConnectionStatus(a.CONNECTED),null},a.prototype.onDisconnected=function(){return THREEFLOW.log("[Disconnected]"),this.connected=!1,this.rendering=!1,this.setConnectionStatus(a.DISCONNECTED),null},a.prototype.onRenderAdded=function(){return this.onRenderStatus.dispatch({status:a.RENDER_ADDED}),null},a.prototype.onRenderStart=function(){return this.onRenderStatus.dispatch({status:a.RENDER_START}),null},a.prototype.onRenderProgress=function(b){return this.onRenderStatus.dispatch({status:a.RENDER_PROGRESS,progress:b.progress}),null},a.prototype.onRenderComplete=function(b){return this.rendering=!1,this.onRenderStatus.dispatch({status:a.RENDER_COMPLETE,duration:b}),null},a.prototype.onRenderCancelled=function(){return this.rendering=!1,this.onRenderStatus.dispatch({status:a.RENDER_CANCELLED}),null},a.prototype.onRenderError=function(b){return this.rendering=!1,this.onRenderStatus.dispatch({status:a.RENDER_ERROR,message:b}),null},a}(),THREEFLOW.VERSION="0.6.0-6",THREEFLOW.COMMIT="e9a0fde",b=function(){function a(a){this.exporter=a}return a.prototype.clean=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.addToIndex=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.doTraverse=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportBlock=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportColorTHREE=function(a){return'{ "sRGB nonlinear" '+a.r+" "+a.g+" "+a.b+" }"},a.prototype.exportColorHex=function(a){var b,c,d;return d=(a>>16&255)/255,c=(a>>8&255)/255,b=(255&a)/255,'{ "sRGB nonlinear" '+d+" "+c+" "+b+" }"},a.prototype.exportVector=function(a){return a.x+" "+a.y+" "+a.z},a.prototype.exportFace=function(a){return a.a+" "+a.b+" "+a.c},a.prototype.exportTransform=function(a){var b,c,d,e,f;for(c="",f=a.matrixWorld.elements,d=0,e=f.length;e>d;d++)b=f[d],c+=" "+b;return c},a.prototype.exportTransformPosition=function(a){var b,c;return c="",b=a.matrixWorld.elements,c+=b[12]+" "+b[13]+" "+b[14]},a}(),c=function(a){function b(a){b.__super__.constructor.call(this,a),this.orderTypes=b.ORDER_TYPES,this.enabled=!0,this.reverse=!1,this.size=16,this.order=this.orderTypes[0]}return F(b,a),b.ORDER_TYPES=["hilbert","spiral","column","row","diagonal","random"],b.prototype.clean=function(){return null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(a=this.size+" ",a+=this.reverse?'"reverse '+this.order+'"':this.order,b+="bucket "+a+"\n"):b},b}(b),d=function(a){function b(a){b.__super__.constructor.call(this,a),this.normals=!0,this.uvs=!1,this.geometrySourceCache={},this.bufferGeometryIndex=null}return F(b,a),b.prototype.clean=function(){return this.bufferGeometryIndex={},null},b.prototype.addToIndex=function(a){return!a instanceof THREE.Mesh?void 0:(a.geometry instanceof THREE.BufferGeometry&&!this.bufferGeometryIndex[a.geometry.uuid]&&(this.bufferGeometryIndex[a.geometry.uuid]={geometry:a.geometry,faceMaterials:!1}),null)},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;k="";for(n in this.bufferGeometryIndex)if(b=this.bufferGeometryIndex[n],!b.geometry._tf_noCache&&this.exporter.useGeometrySourceCache&&this.geometrySourceCache[n])k=this.geometrySourceCache[n];else{for(k+="object {\n",k+="  noinstance\n",k+="  type generic-mesh\n",k+="  name "+n+"\n",i=b.geometry.offsets,a=b.geometry.attributes,j=a.position.array,g=a.normal.array,k+="  points "+j.length/3+"\n",d=o=0,x=j.length;x>o;d=o+=3)k+="    "+j[d]+" "+j[d+1]+" "+j[d+2]+"\n";if(a.index)if(f=a.index.array,i.length){for(m=0,l="",p=0,s=i.length;s>p;p++)for(h=i[p],e=h.index,d=q=y=h.start,z=h.start+h.count;z>q;d=q+=3)m++,l+="    "+(f[d]+e)+" "+(f[d+1]+e)+" "+(f[d+2]+e)+"\n";k+="  triangles "+m+"\n",k+=l}else for(k+="  triangles "+f.length/3+"\n",d=r=0,A=f.length;A>r;d=r+=3)k+="    "+f[d]+" "+f[d+1]+" "+f[d+2]+"\n";else for(k+="  triangles "+j.length/9+"\n",d=u=0,B=j.length/3;B>u;d=u+=3)k+="    "+d+" "+(d+1)+" "+(d+2)+"\n";if(this.normals&&g.length>0){for(k+="  normals vertex\n",d=v=0,C=g.length;C>v;d=v+=3)k+="    "+g[d]+" "+g[d+1]+" "+g[d+2]+"\n";k+="\n"}else k+="  normals none\n";if(k+=this.uvs?"  uvs none\n":"  uvs none\n",b.faceMaterials)for(k+="  face_shaders\n",D=b.geometry.faces,w=0,t=D.length;t>w;w++)c=D[w],k+="    "+c.materialIndex+"\n";k+="}\n\n",!b.geometry._tf_noCache&&this.exporter.useGeometrySourceCache&&(this.geometrySourceCache[n]=k)}return k},b}(b),e=function(a){function b(a){b.__super__.constructor.call(this,a),this.helperVec=new THREE.Vector3,this.camera=null}return F(b,a),b.prototype.clean=function(){return this.camera=null,null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",a+="camera {\n",a+="  type pinhole\n",this.helperVec.copy(this.camera.position),this.helperVec.applyMatrix4(this.camera.matrixWorld),a+="  eye "+this.exportVector(this.camera.position)+"\n",this.helperVec.set(0,0,-1),this.helperVec.applyMatrix4(this.camera.matrixWorld),a+="  target "+this.exportVector(this.helperVec)+"\n",a+="  up "+this.exportVector(this.camera.up)+"\n",a+="  fov "+this.camera.fov*this.camera.aspect+"\n",a+="  aspect "+this.camera.aspect+"\n",a+="}\n\n"},b}(b),f=function(a){function b(a){b.__super__.constructor.call(this,a),this.enabled=!1,this.photons=1e4,this.kdEstimate=100,this.kdRadius=.5}return F(b,a),b.prototype.clean=function(){return null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="photons {\n",a+="  caustics "+this.photons+" kd "+this.kdEstimate+" "+this.kdRadius+"\n",a+="}\n\n"):a},b}(b),i=function(){function a(){a.__checkExcluded(),this.exporterSettings={convertPrimitives:!1},this.blockExporters=[],this.image=this.addBlockExporter(new n(this)),this.bucket=this.addBlockExporter(new c(this)),this.traceDepths=this.addBlockExporter(new C(this)),this.caustics=this.addBlockExporter(new f(this)),this.gi=this.addBlockExporter(new k(this)),this.camera=this.addBlockExporter(new e(this)),this.lights=this.addBlockExporter(new q(this)),this.modifiers=this.addBlockExporter(new v(this)),this.materials=this.addBlockExporter(new s(this)),this.geometry=this.addBlockExporter(new j(this)),this.bufferGeometry=this.addBlockExporter(new d(this)),this.meshes=this.addBlockExporter(new t(this)),this.useGeometrySourceCache=!0,this.textureLinkages={}}return a.EXCLUDED_OBJECT3D_TYPES=[THREE.Camera,THREE.Light,THREE.Bone,THREE.LOD,THREE.Line,THREE.MorphAnimMesh,THREE.ParticleSystem,THREE.SkinnedMesh,THREE.Sprite,THREE.ArrowHelper,THREE.BoundingBoxHelper,THREE.DirectionalLightHelper,THREE.HemisphereLightHelper,THREE.PointLightHelper,THREE.SpotLightHelper,THREE.ImmediateRenderObject,THREE.LensFlare,THREE.MorphBlendMesh],a.__checkedExcluded=!1,a.__checkExcluded=function(){var b,c,d,e;if(!a.__checkedExcluded){for(b=[THREE.TransformControls,THREE.AudioObject],d=0,e=b.length;e>d;d++)c=b[d],void 0!==c&&"function"==typeof c&&a.EXCLUDED_OBJECT3D_TYPES.push(c);a.__checkedExcluded=!0}return null},a.prototype.linkTexturePath=function(a,b){if(!a instanceof THREE.Texture)throw new Error("Texture must be of type THREE.Texture.");if(null===b)throw new Error("Texture path must not be null.");return this.textureLinkages[a.uuid]=b,null},a.prototype.addBlockExporter=function(a){if(!a instanceof b)throw new Error("Extend BlockExporter");return this.blockExporters.push(a),a},a.prototype.clean=function(){var a,b,c,d;for(d=this.blockExporters,b=0,c=d.length;c>b;b++)a=d[b],a.clean();return null},a.prototype.indexObject3d=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(m=a.EXCLUDED_OBJECT3D_TYPES,g=0,j=m.length;j>g;g++)if(e=m[g],b instanceof e)return void THREEFLOW.warn("Ignored object.",b);if(b.children.length)for(n=b.children,h=0,k=n.length;k>h;h++){for(d=n[h],f=!0,o=this.blockExporters,i=0,l=o.length;l>i;i++)c=o[i],d._tf_noIndex||c.addToIndex(d),f=f&&c.doTraverse(d);!f||d._tf_noTraverse||d._tf_noIndex||this.indexObject3d(d)}return null},a.prototype.exportCode=function(){var a,b,c,d,e;for(b="",e=this.blockExporters,c=0,d=e.length;d>c;c++)a=e[c],b+=a.exportBlock();return b},a}(),j=function(a){function b(a){b.__super__.constructor.call(this,a),this.normals=!0,this.vertexNormals=!1,this.uvs=!0,this.geometrySourceCache={},this.geometryIndex=null}return F(b,a),b.prototype.clean=function(){return this.geometryIndex={},null},b.prototype.addToIndex=function(a){var b;if(!(!a instanceof THREE.Mesh)){if(a.geometry instanceof THREE.Geometry){if(a.geometry instanceof THREEFLOW.InfinitePlaneGeometry)return;b=a.material instanceof THREE.MeshFaceMaterial,this.geometryIndex[a.geometry.uuid]?!this.geometryIndex[a.geometry.uuid].faceMaterials&&b&&(this.geometryIndex[a.geometry.uuid].faceMaterials=!0):this.geometryIndex[a.geometry.uuid]={geometry:a.geometry,faceMaterials:b}}return null}},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;e="";for(f in this.geometryIndex)if(a=this.geometryIndex[f],!a.geometry._tf_noCache&&this.exporter.useGeometrySourceCache&&this.geometrySourceCache[f])e=this.geometrySourceCache[f];else{for(e+="object {\n",e+="  noinstance\n",e+="  type generic-mesh\n",e+="  name "+f+"\n",e+="  points "+a.geometry.vertices.length+"\n",A=a.geometry.vertices,m=0,q=A.length;q>m;m++)l=A[m],e+="    "+this.exportVector(l)+"\n";for(e+="  triangles "+a.geometry.faces.length+"\n",B=a.geometry.faces,n=0,r=B.length;r>n;n++)b=B[n],e+="    "+this.exportFace(b)+"\n";if(this.normals&&this.vertexNormals){for(d=[],C=a.geometry.faces,o=0,s=C.length;s>o;o++)b=C[o],d[b.a]=b.vertexNormals[0],d[b.b]=b.vertexNormals[1],d[b.c]=b.vertexNormals[2];if(d.length>0&&d.length===a.geometry.vertices.length){for(e+="  normals vertex\n",p=0,t=d.length;t>p;p++)c=d[p],e+="    "+c.x+" "+c.y+" "+c.z+"\n";e+="\n"}else THREEFLOW.warn("Problem with geometry normals.",object3d),e+="  normals none\n"}else if(this.normals&&!this.vertexNormals)for(e+="  normals facevarying\n",D=a.geometry.faces,x=0,u=D.length;u>x;x++)b=D[x],i=b.vertexNormals[0],j=b.vertexNormals[1],k=b.vertexNormals[2],e+="    "+i.x+" "+i.y+" "+i.z+" "+j.x+" "+j.y+" "+j.z+" "+k.x+" "+k.y+" "+k.z+"\n";else e+="  normals none\n";if(this.uvs)if(h=a.geometry.faceVertexUvs[0],h.length===a.geometry.faces.length)for(e+="  uvs facevarying\n",y=0,v=h.length;v>y;y++)g=h[y],e+="    "+g[0].x+" "+g[0].y+" "+g[1].x+" "+g[1].y+" "+g[2].x+" "+g[2].y+"\n";else THREEFLOW.warn("UV count didn't match face count.",a.geometry),e+="  uvs none\n";else e+="  uvs none\n";if(a.faceMaterials)for(e+="  face_shaders\n",E=a.geometry.faces,z=0,w=E.length;w>z;z++)b=E[z],e+="    "+b.materialIndex+"\n";e+="}\n\n",!a.geometry._tf_noCache&&this.exporter.useGeometrySourceCache&&(this.geometrySourceCache[f]=e)}return e},b}(b),k=function(a){function b(a){b.__super__.constructor.call(this,a),this.type=b.TYPES[0],this.enabled=!1,this.globalMapTypes=b.GLOBAL_MAP_TYPES,this.types=b.TYPES,this.irrCache={samples:512,tolerance:.01,spacingMin:.05,spacingMax:5,globalEnabled:!1,globalPhotons:1e4,globalMap:b.GLOBAL_MAP_TYPES[0],globalEstimate:100,globalRadius:.75},this.igi={samples:64,sets:1,bias:.01,biasSamples:0},this.path={samples:32},this.ambOcc={samples:32,bright:16777215,dark:0,maxDistance:3},this.fake={up:new THREE.Vector3(0,1,0),sky:10526959,ground:15724527}}return F(b,a),b.GLOBAL_MAP_TYPES=["grid","path"],b.TYPES=["igi","irr-cache","path","ambocc","fake"],b.prototype.clean=function(){return null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(b+="gi {\n",b+="  type "+this.type+"\n","igi"===this.type?(b+="  samples "+this.igi.samples+"\n",b+="  sets "+this.igi.sets+"\n",b+="  b "+this.igi.bias+"\n",b+="  bias-samples "+this.igi.biasSamples+"\n"):"irr-cache"===this.type?(b+="  samples "+this.irrCache.samples+"\n",b+="  tolerance "+this.irrCache.tolerance+"\n",b+="  spacing "+this.irrCache.spacingMin+" "+this.irrCache.spacingMax+"\n",this.irrCache.globalEnabled&&(a="  global ",a+=this.irrCache.globalPhotons+" ",a+=this.irrCache.globalMap+" ",a+=this.irrCache.globalEstimate+" ",a+=this.irrCache.globalRadius+"\n",b+=a)):"path"===this.type?b+="  samples "+this.path.samples+"\n":"ambocc"===this.type?(b+='  bright { "sRGB nonlinear" 1 1 1 }\n',b+='  dark { "sRGB nonlinear" 0 0 0 }\n',b+="  samples "+this.ambOcc.samples+"\n",b+="  maxdist "+this.ambOcc.maxDistance+"\n"):"fake"===this.type&&(b+="  up "+this.exportVector(this.fake.up)+"\n",b+="  sky "+this.exportColorHex(this.fake.sky)+"\n",b+="  ground "+this.exportColorHex(this.fake.ground)+"\n"),b+="}\n\n"):b},b}(b),n=function(a){function b(a){b.__super__.constructor.call(this,a),this.resolutionX=800,this.resolutionY=600,this.antialiasMin=-1,this.antialiasMax=1,this.samples=2,this.contrast=.1,this.filter=b.FILTERS[0],this.jitter=!0,this.filterTypes=b.FILTERS}return F(b,a),b.FILTERS=["box","triangle","gaussian","mitchell","catmull-rom","blackman-harris","sinc","lanczos","ospline"],b.prototype.clean=function(){return null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",a+="image {\n",a+="  resolution "+this.resolutionX+" "+this.resolutionY+"\n",a+="  aa "+this.antialiasMin+" "+this.antialiasMax+"\n",a+="  samples "+this.samples+"\n",a+="  contrast "+this.contrast+"\n",a+="  filter "+this.filter+"\n",a+="  jitter "+this.jitter+"\n",a+="}\n\n"},b}(b),q=function(a){function b(a){b.__super__.constructor.call(this,a),this.override={samples:{enabled:!1,value:64}},this.helperVec=new THREE.Vector3,this.lightIndex=null}return F(b,a),b.prototype.clean=function(){return this.lightIndex={},null},b.prototype.addToIndex=function(a){var b;return b=this.lightIndex[a.uuid],!b&&a instanceof THREEFLOW.SunskyLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.PointLight?this.lightIndex[a.uuid]=a:!b&&a instanceof THREEFLOW.AreaLight&&(this.lightIndex[a.uuid]=a),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k;c="";for(d in this.lightIndex)if(b=this.lightIndex[d],b instanceof THREEFLOW.SunskyLight)c+="light {\n",c+="  type sunsky\n",c+="  up "+this.exportVector(b.up)+"\n",c+="  east "+this.exportVector(b.east)+"\n",c+="  sundir "+this.exportVector(b.direction)+"\n",c+="  turbidity "+b.turbidity+"\n",c+=this.override.samples.enabled?"  samples "+this.override.samples.value+"\n":"  samples "+b.samples+"\n",c+="}\n\n";else if(b instanceof THREEFLOW.PointLight)c+="light {\n",c+="  type point\n",c+="  color "+this.exportColorTHREE(b.color)+"\n",c+="  power "+b.power+" \n",c+="  p "+this.exportVector(b.position)+"\n",c+="}\n\n";else if(b instanceof THREEFLOW.AreaLight){for(c+="light {\n",c+="  type meshlight\n",c+="  name "+b.uuid+"\n",c+="  emit "+this.exportColorTHREE(b.color)+"\n",c+="  radiance "+b.radiance+" \n",c+=this.override.samples.enabled?"  samples "+this.override.samples.value+"\n":"  samples "+b.samples+"\n",c+="  points "+b.geometry.vertices.length+"\n",j=b.geometry.vertices,f=0,h=j.length;h>f;f++)e=j[f],this.helperVec.copy(e),this.helperVec.applyMatrix4(b.matrixWorld),c+="    "+this.exportVector(this.helperVec)+"\n";for(c+="  triangles "+b.geometry.faces.length+"\n",k=b.geometry.faces,g=0,i=k.length;i>g;g++)a=k[g],c+="    "+this.exportFace(a)+"\n";c+="}\n\n"}return c},b}(b),s=function(a){function b(a){b.__super__.constructor.call(this,a),this.materialsIndex=null}return F(b,a),b.prototype.clean=function(){return this.materialsIndex={},null},b.prototype.addToIndex=function(a){var b,c,d,e;if(a instanceof THREE.Mesh)if(a.material instanceof THREE.MeshFaceMaterial)for(e=a.material.materials,c=0,d=e.length;d>c;c++)b=e[c],this.materialsIndex[b.uuid]||(this.materialsIndex[b.uuid]=b);else a.material&&!this.materialsIndex[a.material.uuid]&&(this.materialsIndex[a.material.uuid]=a.material);return null},b.prototype.doTraverse=function(){return!0},b.prototype.declareDiffOrTexture=function(a){var b,c,d;return c="",b=a.map instanceof THREE.Texture,d=b?this.exporter.textureLinkages[a.map.uuid]:null,b&&!d&&(THREEFLOW.warn("Found texture on material but no texture linkage.","( Use linkTexturePath() )"),b=!1),c+=b?'  texture "'+d+'"\n':"  diff "+this.exportColorTHREE(a.color)+"\n"},b.prototype.exportBlock=function(){var a,b,c;b="";for(c in this.materialsIndex)a=this.materialsIndex[c],b+="shader {\n",b+="  name "+a.uuid+"\n",a instanceof THREEFLOW.ConstantMaterial||a instanceof THREE.MeshBasicMaterial?(b+="  type constant\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.DiffuseMaterial||a instanceof THREE.MeshLambertMaterial?(b+="  type diffuse\n",b+=this.declareDiffOrTexture(a)):a instanceof THREEFLOW.ShinyMaterial?(b+="  type shiny\n",b+=this.declareDiffOrTexture(a),b+="  refl "+a.reflection+"\n"):a instanceof THREEFLOW.GlassMaterial?(b+="  type glass\n",b+="  eta "+a.eta+"\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof THREEFLOW.MirrorMaterial?(b+="  type mirror\n",b+="  refl "+this.exportColorTHREE(a.reflection)+"\n"):a instanceof THREEFLOW.PhongMaterial||a instanceof THREE.MeshPhongMaterial?(b+="  type phong\n",b+=this.declareDiffOrTexture(a),b+="  spec "+this.exportColorTHREE(a.specular)+" "+a.shininess+"\n",b+="  samples "+(a.samples||4)+"\n"):(THREEFLOW.warn("Unsupported Material type. Will map to black THREEFLOW.DiffuseMaterial.",a),b+="  type diffuse\n",b+='  diff { "sRGB nonlinear" 0 0 0 }\n'),b+="}\n\n";return b},b}(b),t=function(a){function b(a){b.__super__.constructor.call(this,a),this.convertPrimitives=!0,this.meshIndex=null}return F(b,a),b.prototype.clean=function(){return this.meshIndex={},null},b.prototype.addToIndex=function(a){return a instanceof THREE.Mesh?(this.meshIndex[a.uuid]||(this.meshIndex[a.uuid]=a),null):void 0},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g;c="";for(d in this.meshIndex){if(b=this.meshIndex[d],b.geometry instanceof THREEFLOW.InfinitePlaneGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type plane\n",c+="  p "+this.exportTransformPosition(b)+"\n",c+="  n "+this.exportVector(b.up)+"\n";else if(this.convertPrimitives&&b.geometry instanceof THREE.SphereGeometry)c+="object {\n",c+="  shader "+b.material.uuid+"\n",c+="  type sphere\n",c+="  name "+b.uuid+"\n",c+="  c "+this.exportTransformPosition(b)+"\n",c+="  r "+b.geometry.radius+"\n";else if(b.material instanceof THREE.MeshFaceMaterial)for(c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shaders "+b.material.materials.length+"\n",g=b.material.materials,e=0,f=g.length;f>e;e++)a=g[e],c+="    "+a.uuid+"\n";else c+="instance {\n",c+="  name "+b.uuid+"\n",c+="  geometry "+b.geometry.uuid+"\n",c+="  transform col"+this.exportTransform(b)+"\n",c+="  shader "+b.material.uuid+"\n",b.material.bumpMap&&(c+="  modifier "+b.material.uuid+"-MOD\n");c+="}\n\n"}return c},b}(b),v=function(a){function b(a){b.__super__.constructor.call(this,a),this.modifiersIndex=null}return F(b,a),b.prototype.clean=function(){return this.modifiersIndex={},null},b.prototype.addToIndex=function(a){var b;if(a instanceof THREE.Mesh)return b=a.material,!this.modifiersIndex[b.uuid]&&b.bumpMap instanceof THREE.Texture&&(this.modifiersIndex[b.uuid]=b),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d;b="";for(d in this.modifiersIndex)a=this.modifiersIndex[d],c=this.exporter.textureLinkages[a.bumpMap.uuid],c?(b+="modifier {\n",b+="  name "+a.uuid+"-MOD\n",b+="  type bump\n",b+="  texture "+c+"\n",b+="  scale "+a.bumpScale*-.005+"\n",b+="}\n"):THREEFLOW.warn("Found bumpMap texture on material but no texture linkage.","( Use linkTexturePath() )");return b},b}(b),C=function(a){function b(a){b.__super__.constructor.call(this,a),this.enabled=!1,this.diffusion=4,this.reflection=4,this.refraction=4}return F(b,a),b.prototype.clean=function(){return null},b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.enabled?(a+="trace-depths {\n",a+="  diff "+this.diffusion+"\n",a+="  refl "+this.reflection+"\n",a+="  refr "+this.refraction+"\n",a+="}\n\n"):a},b}(b),THREEFLOW.InfinitePlaneGeometry=function(a,b,c,d){var e,f,g,h,i,j;for(a=a||1e3,b=b||1e3,c=c||10,d=d||10,THREE.PlaneGeometry.call(this,a,b,c,d),f=new THREE.Matrix4,f.makeRotationX(Math.PI/2),this.applyMatrix(f),g=new THREE.Vector3(0,1,0),j=this.faces,h=0,i=j.length;i>h;h++)e=j[h],e.normal.copy(g),e.vertexNormals[0].copy(g),e.vertexNormals[1].copy(g),e.vertexNormals[2].copy(g);return this.computeCentroids()},THREEFLOW.InfinitePlaneGeometry.prototype=Object.create(THREE.PlaneGeometry.prototype),THREEFLOW.Gui=m=function(){function a(a,b){var c,d,e,f,g,h,i,j,k=this;if(this.renderer=a,this.lightingRig=b,this._onRenderIPR=D(this._onRenderIPR,this),this._onRender=D(this._onRender,this),!window.dat&&!window.dat.GUI)throw new Error("No dat.GUI found.");if(this.gui=new dat.GUI,this.onRender=new THREEFLOW.Signal,e=function(){var a,b,c,d,e;for(d=k.gui.__controllers,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.updateDisplay());return e},d={status:""},this.renderer.onConnectionStatus.add(function(a){return d.status=a.status,e()}),this.renderer.onRenderStatus.add(function(a){return d.status=a.status===THREEFLOW.SunflowRenderer.RENDER_PROGRESS?"rendering / "+a.progress+"%":a.status,e()}),this.gui.add(THREEFLOW,"VERSION").name("THREEFLOW"),this.gui.add(d,"status").name("Status"),this.gui.add(this,"_onRender").name("Render"),this.gui.add(this,"_onRenderIPR").name("Render IPR"),this.imageFolder=this.gui.addFolder("Image"),this.lightingRig){for(this.lightingRigFolder=this.gui.addFolder("Lighting Rig"),this.lightingRigFolder.add(this.lightingRig,"saveState").name("Dump JSON").onChange(function(){var a;return a=k.lightingRig.saveState(),console.log(JSON.stringify(a))}),j=this.lightingRig.lights,h=0,i=j.length;i>h;h++)c=j[h],this.addRigLight(this.lightingRigFolder,c);this.backdropFolder=this.lightingRigFolder.addFolder("Backdrop"),this.backdropFolder.add(this.lightingRig.backdropMaterial,"wireframe"),this.backdropFolder.add(this.lightingRig.backdropMaterial,"transparent"),this.backdropFolder.add(this.lightingRig.backdropMaterial,"opacity",0,1)}this.giFolder=this.gui.addFolder("Global Illumination"),this.traceDepthsFolder=this.gui.addFolder("Trace Depths"),this.causticsFolder=this.gui.addFolder("Caustics"),this.bucketFolder=this.gui.addFolder("Bucket"),this.moreFolder=this.gui.addFolder("Later / Other"),this.overridesFolder=this.moreFolder.addFolder("Overrides"),this.otherFolder=this.moreFolder.addFolder("Flags"),this.imageFolder.add(this.renderer,"scale"),this.imageFolder.add(this.renderer.image,"antialiasMin"),this.imageFolder.add(this.renderer.image,"antialiasMax"),this.imageFolder.add(this.renderer.image,"samples"),this.imageFolder.add(this.renderer.image,"contrast"),this.imageFolder.add(this.renderer.image,"filter",this.renderer.image.filterTypes),this.imageFolder.add(this.renderer.image,"jitter"),this.bucketFolder.add(this.renderer.bucket,"enabled"),this.bucketFolder.add(this.renderer.bucket,"size"),this.bucketFolder.add(this.renderer.bucket,"order",this.renderer.bucket.orderTypes),this.bucketFolder.add(this.renderer.bucket,"reverse"),this.traceDepthsFolder.add(this.renderer.traceDepths,"enabled"),this.traceDepthsFolder.add(this.renderer.traceDepths,"diffusion"),this.traceDepthsFolder.add(this.renderer.traceDepths,"reflection"),this.traceDepthsFolder.add(this.renderer.traceDepths,"refraction"),this.causticsFolder.add(this.renderer.caustics,"enabled"),this.causticsFolder.add(this.renderer.caustics,"photons"),this.causticsFolder.add(this.renderer.caustics,"kdEstimate"),this.causticsFolder.add(this.renderer.caustics,"kdRadius"),this.overridesFolder.add(this.renderer.lights.override.samples,"enabled").name("lightSamples"),this.overridesFolder.add(this.renderer.lights.override.samples,"value").name("lightValue"),this.otherFolder.add(this.renderer.meshes,"convertPrimitives"),this.otherFolder.add(this.renderer.geometry,"normals").name("geomNormals"),this.otherFolder.add(this.renderer.bufferGeometry,"normals").name("bufferGeomNormals"),this.giFolder.add(this.renderer.gi,"enabled"),this.giFolder.add(this.renderer.gi,"type",this.renderer.gi.types).onChange(function(a){return g(a)}),this.giTypes=[{type:this.renderer.gi.types[0],name:"Instant GI",property:"igi"},{type:this.renderer.gi.types[1],name:"Irradiance Caching / Final Gathering",property:"irrCache"},{type:this.renderer.gi.types[2],name:"Path Tracing",property:"path"},{type:this.renderer.gi.types[3],name:"Ambient Occlusion",property:"ambOcc"},{type:this.renderer.gi.types[4],name:"Fake Ambient Term",property:"fake"}],this.giSubFolder=null,f=function(a){var b,c,d,e,f,g,h,i;if(k.giSubFolder){for(c=k.giSubFolder.__controllers.slice(0),h=0,i=c.length;i>h;h++)b=c[h],k.giSubFolder.remove(b);k.giSubFolder.__controllers.splice(0),k.giSubFolder.__ul.firstChild.innerHTML=a.name}else k.giSubFolder=k.giFolder.addFolder(a.name);e=a.type,f=a.property;for(g in k.renderer.gi[f])"irr-cache"===e&&"globalMap"===g?k.giSubFolder.add(k.renderer.gi.irrCache,"globalMap",k.renderer.gi.globalMapTypes):"ambocc"!==e||"bright"!==g&&"dark"!==g?"fake"===e&&"up"===g?(d={upX:k.renderer.gi.fake.up.x,upY:k.renderer.gi.fake.up.y,upZ:k.renderer.gi.fake.up.z},k.giSubFolder.add(d,"upX").onChange(function(a){return this.renderer.gi.fake.up.x=a}),k.giSubFolder.add(d,"upY").onChange(function(a){return this.renderer.gi.fake.up.y=a}),k.giSubFolder.add(d,"upZ").onChange(function(a){return this.renderer.gi.fake.up.z=a})):"fake"!==e||"sky"!==g&&"ground"!==g?k.giSubFolder.add(k.renderer.gi[f],g):k.giSubFolder.addColor(k.renderer.gi.fake,g):k.giSubFolder.addColor(k.renderer.gi.ambOcc,g);return k.giSubFolder.open(),null},(g=function(a){return k.renderer.gi.type=a,f(k.giTypes[k.renderer.gi.types.indexOf(a)]),null})(this.renderer.gi.type)}return a.prototype.addRigLight=function(a,b){var c;return c=a.addFolder(b.name),c.add(b,"enabled"),b.isKey?(c.open(),c.add(b,"radiance",0,200)):c.add(b,"radiance",0,200),c.add(b,"samples",16,512).step(16),c.addColor(b,"color"),c.add(b,"geometryType",THREEFLOW.LightingRigLight.LIGHT_GEOMETRY_TYPES)},a.prototype._onRender=function(){return this.renderer.sunflowCl.ipr=!1,this.onRender.dispatch()},a.prototype._onRenderIPR=function(){return this.renderer.sunflowCl.ipr=!0,this.onRender.dispatch()},a}(),THREEFLOW.AreaLight=a=function(){function a(a){null==a&&(a={}),THREE.Object3D.call(this),this._tf_noTraverse=!0,this._color=new THREE.Color(a.color),this._radiance=a.radiance||100,this.samples=a.samples||16,this.markerMaterial=new THREE.MeshBasicMaterial({wireframe:!0,side:THREE.DoubleSide,color:this._color}),this.lineGeometry=new THREE.Geometry,this.lineGeometry.vertices.push(new THREE.Vector3),this.lineGeometry.vertices.push(new THREE.Vector3(0,0,100)),this.lineMesh=new THREE.Line(this.lineGeometry,new THREE.LineBasicMaterial({color:this._color.getHex()})),this.lineMesh.name="LINE MESH",this.lineMesh.matrixAutoUpdate=!1,this.add(this.lineMesh),this.toIntensity=1,this.planar=!0,this.planarDirection=new THREE.Vector3,this.geometryMesh=null,this.geometry=a.geometry||new THREE.PlaneGeometry(100,100),a.simulate!==!1&&(this.simulate=!0)}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a,this.light&&this.light.color.setRGB(this._color),this.markerMaterial.color=this._color}},radiance:{get:function(){return this._radiance
},set:function(a){return this._radiance!==a?this._radiance=a:void 0}},simulate:{get:function(){return this._simulate},set:function(a){return this._simulate!==a?(this._simulate=a,this.updateLight()):void 0}},geometry:{get:function(){return this._geometry},set:function(a){var b,c;if(this._geometry!==a&&a)return this._geometry=a,this.geometryMesh&&this.remove(this.geometryMesh),this._geometry.boundingBox||this._geometry.computeBoundingBox(),b=this._geometry.boundingBox.size(),c=0,this.planar=!0,0===b.x?(c=b.y*b.z,this.planarDirection.set(1,0,0)):0===b.y?(c=b.x*b.z,this.planarDirection.set(0,1,0)):0===b.z?(c=b.x*b.y,this.planarDirection.set(0,0,1)):(c=b.x*b.y*b.z,this.planar=!1),this.toIntensity=this.planar?1e-5*c:c/1e6,this.updateLight(),this.geometryMesh=new THREE.Mesh(this._geometry,this.markerMaterial),this.add(this.geometryMesh),this.geometryMesh.name="GEOMETRY MESH"}}}),a.prototype.updateLight=function(){if(!this._simulate&&this.light)this.remove(this.light);else if(this._simulate){if(this._simulate&&!this.light)return this.planar?(this.light=new THREE.DirectionalLight(this._color,1),this.light.position.set(0,0,0),this.light.target.position.copy(this.planarDirection)):this.light=new THREE.PointLight(this._color,1),this.add(this.light);if(this.planar&&this.light instanceof THREE.PointLight)return this.remove(this.light),this.light=new THREE.DirectionalLight(this._color,1),this.light.position.set(0,0,0),this.light.target.position.copy(this.planarDirection),this.add(this.light);if(!this.planar&&this.light instanceof THREE.DirectionalLight)return this.remove(this.light),this.light=new THREE.PointLight(this._color,1),this.add(this.light)}else;},a}(),THREEFLOW.PointLight=x=function(){function a(a){var b,c,d;null==a&&(a={}),THREE.Object3D.call(this),this._tf_noTraverse=!0,a.simulate!==!1&&(this.simulate=!0),a.markers!==!1&&(this.markers=!0),this._color=new THREE.Color(a.color),this._power=a.power||100,this.markers&&(c=a.markerSize||1,b=new THREE.SphereGeometry(c,3,3),d=new THREE.MeshBasicMaterial({wireframe:!0}),d.color=this._color,this.mesh=new THREE.Mesh(b,d),this.add(this.mesh)),this.simulate&&(this.light=new THREE.PointLight(a.color,a.intensity,a.distance),this.light.color=this._color,this.add(this.light))}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this._color},set:function(a){return this._color=a}},power:{get:function(){return this._power},set:function(a){return this._power=a}}}),a}(),THREEFLOW.SunskyLight=B=function(){function a(a){THREE.Object3D.call(this),this._tf_noTraverse=!0,a=a||{},this.up=a.up||new THREE.Vector3(0,1,0),this.east=a.east||new THREE.Vector3(0,0,1),this.direction=a.direction||new THREE.Vector3(1,1,1),this.turbidity=a.turbidity||2,this.samples=a.samples||32,a.simulate!==!1&&(a.simulate=!0),a.dirLight!==!1&&(a.dirLight=!0),a.hemLight!==!1&&(a.hemLight=!0),a.simulate&&(a.dirLight&&(this.dirLight=new THREE.DirectionalLight(16777215,1),this.add(this.dirLight)),a.hemLight&&(this.hemLight=new THREE.HemisphereLight(16777215,3355443,.8),this.add(this.hemLight)))}return a.prototype=Object.create(THREE.Object3D.prototype),a}(),THREEFLOW.ConstantMaterial=g=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),THREE.MeshLambertMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshLambertMaterial.prototype),a}(),THREEFLOW.DiffuseMaterial=h=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.GlassMaterial=l=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.eta&&(a.eta=1),this.eta=a.eta,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.MirrorMaterial=u=function(){function a(a){null==a&&(a={}),THREE.MeshPhongMaterial.call(this),this.setValues(a),this.reflection=this.color}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.PhongMaterial=w=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.power&&(this.power=100),void 0===a.samples&&(this.samples=4),THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.ShinyMaterial=y=function(){function a(a){null==a&&(a={}),void 0===a.color&&(a.color=16777215),void 0===a.reflection&&(a.reflection=.5),this.reflection=a.reflection,THREE.MeshPhongMaterial.call(this),this.setValues(a)}return a.prototype=Object.create(THREE.MeshPhongMaterial.prototype),a}(),THREEFLOW.LightingRig=o=function(){function a(a,b,c){this.camera=a,this.domElement=b,null==c&&(c={}),this.onKeyDown=D(this.onKeyDown,this),this.onPointerUp=D(this.onPointerUp,this),this.onPointerDown=D(this.onPointerDown,this),this.onTransformChange=D(this.onTransformChange,this),THREE.Object3D.call(this),c.backdropWall=c.backdropWall||600,c.backdropFloor=c.backdropFloor||1500,c.backdropCurve=c.backdropCurve||400,c.backdropCurveSteps=c.backdropCurveSteps||20,c.backdropMaterial=c.backdropMaterial||new THREEFLOW.DiffuseMaterial({color:15724527,ambient:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.5}),this.backdropMaterial=c.backdropMaterial,this.createBackdrop(c.backdropWall,c.backdropFloor,c.backdropCurve,c.backdropCurveSteps,c.backdropMaterial),this.ambient=new THREE.AmbientLight(2434341),this.ambient._tf_noIndex=!0,this.add(this.ambient),this._keyRadiance=5.5,this.lights=[new THREEFLOW.LightingRigLight(this,!0,{name:"Key Light",light:{color:16777199,geometryType:"Plane",radiance:this._keyRadiance}}),new THREEFLOW.LightingRigLight(this,!1,{enabled:!1,name:"Fill Light",light:{color:16777199,geometryType:"Plane",simulate:!1}}),new THREEFLOW.LightingRigLight(this,!1,{enabled:!1,name:"Back/Rim Light",light:{color:16777199,geometryType:"Plane",simulate:!1}}),new THREEFLOW.LightingRigLight(this,!1,{enabled:!1,name:"Background Light",light:{color:16777199,geometryType:"Plane",simulate:!1}})],this.projector=new THREE.Projector,this.raycaster=new THREE.Raycaster,this.pointerVec=new THREE.Vector3,this.domElement.addEventListener("mousedown",this.onPointerDown,!1),this.domElement.addEventListener("mouseup",this.onPointerUp,!1),window.addEventListener("keydown",this.onKeyDown,!1),this.transformControls=new THREE.TransformControls(this.camera,this.domElement),this.transformControls.addEventListener("change",this.onTransformChange),this.orbitControls=new THREE.OrbitControls(this.camera,this.domElement),this.transformControls._tf_noIndex=!0,this.add(this.transformControls),this.enabledLights=[],this.lightsDirty=!0,this.keyRadianceDirty=!0,this.update()}return a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{keyRadiance:{get:function(){return this._keyRadiance},set:function(a){return this._keyRadiance!==a?(this._keyRadiance=a,this.keyRadianceDirty=!0):void 0}}}),a.prototype.onTransformChange=function(a){var b,c,d,e;for("pointer-down"!==a.state&&"pointer-hover"!==a.state||!this.orbitControls.enabled?"pointer-up"!==a.state||this.orbitControls.enabled||(this.orbitControls.enabled=!0):this.orbitControls.enabled=!1,e=this.enabledLights,c=0,d=e.length;d>c;c++)b=e[c],b.lookAtDirty=!0;return this.transformControls.update()},a.prototype.onPointerDown=function(a){return a.preventDefault(),null},a.prototype.saveState=function(){var a,b,c,d,e,f;for(c={},c.lights=[],f=this.lights,d=0,e=f.length;e>d;d++)b=f[d],a={},a.enabled=b.enabled,a.color=b.color,a.radiance=b.radiance,a.geometryType=b.geometryType,a.target={},a.target.x=b.targetMesh.position.x,a.target.y=b.targetMesh.position.y,a.target.z=b.targetMesh.position.z,a.light={},a.light.x=b.light.position.x,a.light.y=b.light.position.y,a.light.z=b.light.position.z,a.light.sx=b.light.scale.x,a.light.sy=b.light.scale.y,a.light.sz=b.light.scale.z,c.lights.push(a);return c.camera={},c.camera.x=this.camera.position.x,c.camera.y=this.camera.position.y,c.camera.z=this.camera.position.z,c.camera.rx=this.camera.rotation.x,c.camera.rx=this.camera.rotation.y,c.camera.rz=this.camera.rotation.z,c.camera.ord=this.camera.rotation.order,c.orbit={},c.orbit.x=this.orbitControls.target.x,c.orbit.y=this.orbitControls.target.y,c.orbit.z=this.orbitControls.target.z,c},a.prototype.loadState=function(a){var b,c,d,e,f;for("string"==typeof a&&(a=JSON.parse(a)),this.keyRadiance=a.keyRadiance,f=a.lights,b=d=0,e=f.length;e>d;b=++d)c=f[b],this.lights[b].enabled=c.enabled,this.lights[b].color=c.color,this.lights[b].radiance=c.radiance,this.lights[b].geometryType=c.geometryType,this.lights[b].targetMesh.position.set(c.target.x,c.target.y,c.target.z),this.lights[b].light.position.set(c.light.x,c.light.y,c.light.z),this.lights[b].light.scale.set(c.light.sx,c.light.sy,c.light.sz),this.lights[b].lookAtDirty=!0;return a.camera&&(this.camera.position.set(a.camera.x,a.camera.y,a.camera.z),this.camera.rotation.set(a.camera.rx,a.camera.ry,a.camera.rz,a.camera.ord)),a.orbit&&(this.orbitControls.target.x=a.orbit.x,this.orbitControls.target.y=a.orbit.y,this.orbitControls.target.z=a.orbit.z,this.orbitControls.update()),null},a.prototype.onPointerUp=function(a){var b;return a.preventDefault(),b=this.getIntersection(),b?(this.orbitControls.enabled=!1,b.object.parent instanceof THREEFLOW.AreaLight?this.transformControls.attach(b.object.parent):b.object.parent instanceof THREEFLOW.LightingRigLight&&this.transformControls.attach(b.object),this.transformControls.setMode("translate")):this.transformControls.detach(this.transformControls.object),null},a.prototype.getIntersection=function(){var a,b,c,d,e,f,g,h,i,j;for(e=this.domElement.getBoundingClientRect(),f=(event.clientX-e.left)/e.width,g=(event.clientY-e.top)/e.height,this.pointerVec.set(2*f-1,2*-g+1,1),this.projector.unprojectVector(this.pointerVec,this.camera),this.raycaster.set(this.camera.position,this.pointerVec.sub(this.camera.position).normalize()),d=[],j=this.enabledLights,h=0,i=j.length;i>h;h++)c=j[h],d.push(c.light.geometryMesh,c.targetMesh);return b=this.raycaster.intersectObjects(d,!0),a=null,b.length&&(a=b[0]),a},a.prototype.onKeyDown=function(a){var b;if(b=this.transformControls.object){if(b instanceof THREEFLOW.AreaLight)switch(a.keyCode){case 81:this.transformControls.setSpace("local"===this.transformControls.space?"world":"local");break;case 87:this.transformControls.setMode("translate");break;case 82:this.transformControls.setMode("scale")}else if(b.parent instanceof THREEFLOW.LightingRigLight)switch(a.keyCode){case 81:this.transformControls.setSpace("local"===this.transformControls.space?"world":"local");break;case 87:this.transformControls.setMode("translate")}return null}},a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k;if(this.lightsDirty){for(this.lightsDirty=!1,h=this.enabledLights,b=0,e=h.length;e>b;b++)a=h[b],a.parent&&this.remove(a);for(this.enabledLights.splice(0),i=this.lights,c=0,f=i.length;f>c;c++)a=i[c],a.enabled&&(this.add(a),this.enabledLights.push(a))}for(this.orbitControls.update(),this.transformControls.update(),j=this.enabledLights,k=[],d=0,g=j.length;g>d;d++)a=j[d],k.push(a.update());return k},a.prototype.createBackdrop=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p;for(j=[],j.push(new THREE.Vector3),f=Math.PI/2,g=m=n=Math.PI,o=Math.PI-f,p=-(f/d);p>0?o>m:m>o;g=m+=p)k=Math.sin(g)*c+b,l=Math.cos(g)*c+c,j.push(new THREE.Vector3(k,0,l));return j.push(new THREE.Vector3(b+c,0,c+a)),h=new THREE.LatheGeometry(j,12,0,Math.PI),i=new THREE.Mesh(h,e),i.rotation.x=-(Math.PI/2),i.position.z=b/2,this.add(i),null},a}(),THREEFLOW.LightingRigLight=p=function(){function a(a,b,c){var d,e,f;this.rig=a,this.isKey=b,null==c&&(c={}),THREE.Object3D.call(this),this.name=c.name||"RigLight",this._enabled="boolean"==typeof c.enabled?c.enabled:!0,f=new THREE.MeshBasicMaterial({color:16777215,wireframe:!0}),d=new THREE.BoxGeometry(30,30,30),this.targetMesh=new THREE.Mesh(d,f),this.targetMesh.position.set(0,15,0),this.targetMesh._tf_noIndex=!0,this.add(this.targetMesh),this.target=this.targetMesh.position,this._keyRatio=0,this.lightGeomPlane=null,this.lightGeomCircle=null,this.lightGeomBox=null,this.lightGeomSphere=null,this.lightGeomRing=null,e=c.light||{},this._geometryType=e.geometryType?e.geometryType:THREEFLOW.LightingRigLight.DEFAULT_LIGHT_GEOMETRY_TYPE,e.geometry=this.getGeometry(this._geometryType),this.light=new THREEFLOW.AreaLight(e),this.light.position.set(0,0,-100),this.add(this.light),this.lookAtDirty=!0,this.update()}return a.LIGHT_GEOMETRY_TYPES=["Plane","Circle","Box","Sphere","Ring"],a.DEFAULT_LIGHT_GEOMETRY_TYPE="Circle",a.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperties(a.prototype,{color:{get:function(){return this.light.color.getHex()},set:function(a){return this.light.color.setHex(a)}},radiance:{get:function(){return this.light.radiance},set:function(a){return this.light.radiance!==a?(this.isKey&&(this.rig.keyRadiance=a),this.light.radiance=a):void 0}},keyRatio:{get:function(){return this._keyRatio},set:function(a){return this.isKey?void 0:(this.rig.keyRadianceDirty=!0,this._keyRatio=a)}},geometryType:{get:function(){return this._geometryType},set:function(a){var b;if(this._geometryType!==a)return b=this.getGeometry(a),b?this.light.geometry=b:void 0}},enabled:{get:function(){return this._enabled},set:function(a){return this._enabled=a,this.rig?this.rig.lightsDirty=!0:void 0}},samples:{get:function(){return this.light.samples},set:function(a){return this.light.samples=a}}}),a.prototype.update=function(){return this.lookAtDirty&&(this.lookAtDirty=!1,this.light.lookAt(this.target)),this.bounceDirty&&(this.bounceDirty=!1),null},a.prototype.getGeometry=function(a){var b;switch(b=null,a){case"Plane":null===this.lightGeomPlane&&(b=this.lightGeomPlane=new THREE.PlaneGeometry(400,400));break;case"Circle":null===this.lightGeomCircle&&(b=this.lightGeomCircle=new THREE.CircleGeometry(200,12));break;case"Box":null===this.lightGeomBox&&(b=this.lightGeomBox=new THREE.BoxGeometry(200,200,200));break;case"Sphere":null===this.lightGeomSphere&&(b=this.lightGeomSphere=new THREE.SphereGeometry(200));break;case"Ring":null===this.lightGeomRing&&(b=this.lightGeomRing=new THREE.RingGeometry(100,200,12,12))}return b},a}(),r=function(){function a(){this.warn=D(this.warn,this),this.log=D(this.log,this),this.setEnabled=D(this.setEnabled,this),this.enabled=!0,window.console||(window.console={}),window.console.log||(window.console.log=function(){return null})}return a.prototype.setEnabled=function(a){return this.enabled=a,null},a.prototype.args=function(a){return Array.prototype.slice.call(a,0)},a.prototype.log=function(){return this.enabled&&console.log.apply(console,["[Threeflow]"].concat(this.args(arguments))),null},a.prototype.warn=function(){return this.enabled&&console.log.apply(console,["[Threeflow]","!!!"].concat(this.args(arguments))),null},a}(),THREEFLOW.__log=new r,THREEFLOW.log=THREEFLOW.__log.log,THREEFLOW.warn=THREEFLOW.__log.warn,THREEFLOW.Signal=z=function(){function a(){this.listeners=null}return a.prototype.add=function(a){return this.listeners||(this.listeners=[]),-1!==this.listeners.indexOf(a)?!1:(this.listeners.push(a),!0)},a.prototype.remove=function(a){var b;return!this.listeners,b=this.listeners.indexOf(a),-1===b?!1:(this.listeners.splice(b,1),!0)},a.prototype.removeAll=function(){return this.listeners.splice(0),null},a.prototype.dispatch=function(a){var b,c,d,e;if(!this.listeners)return null;for(e=this.listeners,c=0,d=e.length;d>c;c++)(b=e[c])(a);return null},a}()}).call(this);